<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>netty源码学习-pipeline、责任链 | quiterr的个人博客</title>
    <meta name="description" content="quiterr的个人博客">
    <link rel="icon" href="/assets/img/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.2fd3a0e5.css" as="style"><link rel="preload" href="/assets/js/app.d45e7d8d.js" as="script"><link rel="preload" href="/assets/js/3.f201c9f2.js" as="script"><link rel="preload" href="/assets/js/2.58f2d4b3.js" as="script"><link rel="preload" href="/assets/js/48.c9adb86a.js" as="script"><link rel="prefetch" href="/assets/js/10.8f6ff41b.js"><link rel="prefetch" href="/assets/js/11.d3060e6c.js"><link rel="prefetch" href="/assets/js/12.5d5dd355.js"><link rel="prefetch" href="/assets/js/13.b58b39cd.js"><link rel="prefetch" href="/assets/js/14.132da01d.js"><link rel="prefetch" href="/assets/js/15.4de3abff.js"><link rel="prefetch" href="/assets/js/16.5d01f151.js"><link rel="prefetch" href="/assets/js/17.743cc240.js"><link rel="prefetch" href="/assets/js/18.5cd47213.js"><link rel="prefetch" href="/assets/js/19.c31513f4.js"><link rel="prefetch" href="/assets/js/20.ff0c8b17.js"><link rel="prefetch" href="/assets/js/21.23bfd343.js"><link rel="prefetch" href="/assets/js/22.7b1bcdc8.js"><link rel="prefetch" href="/assets/js/23.9aa9bcc6.js"><link rel="prefetch" href="/assets/js/24.41feae7a.js"><link rel="prefetch" href="/assets/js/25.085c0a62.js"><link rel="prefetch" href="/assets/js/26.28112f5e.js"><link rel="prefetch" href="/assets/js/27.3dfa1162.js"><link rel="prefetch" href="/assets/js/28.64b59646.js"><link rel="prefetch" href="/assets/js/29.5da0daa7.js"><link rel="prefetch" href="/assets/js/30.e061c642.js"><link rel="prefetch" href="/assets/js/31.af9d5f01.js"><link rel="prefetch" href="/assets/js/32.3bb3cd16.js"><link rel="prefetch" href="/assets/js/33.28c6384b.js"><link rel="prefetch" href="/assets/js/34.e24d72db.js"><link rel="prefetch" href="/assets/js/35.066a2949.js"><link rel="prefetch" href="/assets/js/36.3605469b.js"><link rel="prefetch" href="/assets/js/37.0f0334ec.js"><link rel="prefetch" href="/assets/js/38.c4e1f427.js"><link rel="prefetch" href="/assets/js/39.bf835b74.js"><link rel="prefetch" href="/assets/js/4.130bd99d.js"><link rel="prefetch" href="/assets/js/40.df4753ea.js"><link rel="prefetch" href="/assets/js/41.c0060482.js"><link rel="prefetch" href="/assets/js/42.13e0dffa.js"><link rel="prefetch" href="/assets/js/43.2a7ba197.js"><link rel="prefetch" href="/assets/js/44.4a50ce9b.js"><link rel="prefetch" href="/assets/js/45.04e3bb01.js"><link rel="prefetch" href="/assets/js/46.f860615e.js"><link rel="prefetch" href="/assets/js/47.57f7e152.js"><link rel="prefetch" href="/assets/js/49.89d283b4.js"><link rel="prefetch" href="/assets/js/5.bc8341b3.js"><link rel="prefetch" href="/assets/js/50.176d29a8.js"><link rel="prefetch" href="/assets/js/51.73ee13f6.js"><link rel="prefetch" href="/assets/js/6.5dc22b3f.js"><link rel="prefetch" href="/assets/js/7.5d9116e6.js"><link rel="prefetch" href="/assets/js/8.ab4e4f3e.js"><link rel="prefetch" href="/assets/js/9.05f51b5b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2fd3a0e5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="quiterr的个人博客" class="logo"> <span class="site-name can-hide">quiterr的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://www.jianshu.com/u/e268fe04200a" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/quiterr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.hanclouds.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  hanclouds
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://www.jianshu.com/u/e268fe04200a" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/quiterr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.hanclouds.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  hanclouds
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/architecture/" class="sidebar-heading clickable"><span>架构设计</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/source/" class="sidebar-heading clickable router-link-active open"><span>源码阅读</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/source/netty/" class="sidebar-heading clickable router-link-active open"><span>netty源码学习</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/source/netty/" class="sidebar-link">netty源码学习-链式编程和建造者</a></li><li><a href="/source/netty/2.html" class="sidebar-link">netty源码学习-反射和工厂</a></li><li><a href="/source/netty/3.html" class="sidebar-link">netty源码学习-3种IO、Reactor</a></li><li><a href="/source/netty/4.html" class="sidebar-link">netty源码学习-多重继承、异步编程、观察者</a></li><li><a href="/source/netty/5.html" class="sidebar-link">netty源码学习-channel注册、适配器</a></li><li><a href="/source/netty/6.html" class="active sidebar-link">netty源码学习-pipeline、责任链</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/source/netty/6.html#初见pipeline" class="sidebar-link">初见pipeline</a></li><li class="sidebar-sub-header"><a href="/source/netty/6.html#事件流转" class="sidebar-link">事件流转</a></li><li class="sidebar-sub-header"><a href="/source/netty/6.html#事件传播" class="sidebar-link">事件传播</a></li><li class="sidebar-sub-header"><a href="/source/netty/6.html#创建pipeline" class="sidebar-link">创建pipeline</a></li><li class="sidebar-sub-header"><a href="/source/netty/6.html#channelhandlercontext介绍" class="sidebar-link">ChannelHandlerContext介绍</a></li><li class="sidebar-sub-header"><a href="/source/netty/6.html#pipeline源码学习" class="sidebar-link">pipeline源码学习</a></li><li class="sidebar-sub-header"><a href="/source/netty/6.html#childhandler源码学习" class="sidebar-link">childHandler源码学习</a></li></ul></li><li><a href="/source/netty/7.html" class="sidebar-link">netty源码学习-原型、模板方法</a></li><li><a href="/source/netty/8.html" class="sidebar-link">netty源码学习-粘包&amp;半包</a></li><li><a href="/source/netty/9.html" class="sidebar-link">keepalive 和 idle</a></li><li><a href="/source/netty/10.html" class="sidebar-link">handler的生命周期</a></li><li><a href="/source/netty/11.html" class="sidebar-link">netty中的锁</a></li><li><a href="/source/netty/12.html" class="sidebar-link">netty如何使用内存</a></li><li><a href="/source/netty/13.html" class="sidebar-link">启动过程</a></li><li><a href="/source/netty/14.html" class="sidebar-link">创建连接</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/source/jdk/" class="sidebar-heading clickable"><span>jdk源码阅读</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/source/quartz" class="sidebar-heading clickable"><span>quartz源码阅读</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/design-pattern/" class="sidebar-heading clickable"><span>设计模式</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/frontend/" class="sidebar-heading clickable"><span>前端开发</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/database/" class="sidebar-heading clickable"><span>数据库</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/collection/" class="sidebar-heading clickable"><span>资料收藏</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="netty源码学习-pipeline、责任链"><a href="#netty源码学习-pipeline、责任链" class="header-anchor">#</a> netty源码学习-pipeline、责任链</h1> <p>本文的知识点：pipeline的概念和相关知识，ChannelHandlerContext介绍、pipeline的源码分析，责任链模式，childHandler的源码分析。</p> <p></p><div class="table-of-contents"><ul><li><a href="#初见pipeline">初见pipeline</a></li><li><a href="#事件流转">事件流转</a></li><li><a href="#事件传播">事件传播</a></li><li><a href="#创建pipeline">创建pipeline</a></li><li><a href="#channelhandlercontext介绍">ChannelHandlerContext介绍</a></li><li><a href="#pipeline源码学习">pipeline源码学习</a></li><li><a href="#childhandler源码学习">childHandler源码学习</a></li></ul></div><p></p> <h2 id="初见pipeline"><a href="#初见pipeline" class="header-anchor">#</a> 初见pipeline</h2> <p>还是<code>io.netty.example.EchoServer</code>，在这里看到了<code>ChannelPipeline</code>的相关代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token punctuation">.</span><span class="token function">childHandler</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelInitializer</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">SocketChannel</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token annotation punctuation">@Override</span>
    <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">initChannel</span><span class="token punctuation">(</span><span class="token class-name">SocketChannel</span> ch<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
        <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token comment">// 删除了几行无关代码</span>
        p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>serverHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p><code>ChannelPipeline</code>就是一组<code>ChannelHandler</code>，而<code>ChannelHandler</code>上节已经说过是用来处理<code>Channel</code>上的流入、流出事件。</p> <p><code>ChannelPipeline</code>是<a href="https://www.oracle.com/technetwork/java/interceptingfilter-142169.html" target="_blank" rel="noopener noreferrer">Intercepting Filter Pattern<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a> 的一种高级实现，给予用户对 <code>event</code>处理 和<code>pipeline</code>中各个 <code>ChannelHandler</code>如何交互 完全的控制能力。</p> <p>每个<code>channel</code>都有一个<code>ChannelPipeline</code>，在<code>channel</code>创建的时候就会自动创建<code>ChannelPipeline</code>。</p> <h2 id="事件流转"><a href="#事件流转" class="header-anchor">#</a> 事件流转</h2> <p>下图描述了<code>ChannelPipeline</code>中的<code>ChannelHandler</code>如何处理<code>IO events</code>。一个<code>IO event</code>被<code>ChannelInboundHandler</code> 或 <code>ChannelOutboundHandler</code>处理，之后通过调用<code>ChannelHandlerContext</code>中定义的<strong>事件传播方法</strong>交给最近的下一个<code>handler</code>，例如<code>ChannelHandlerContext.fireChannelRead(Object)</code> 和 <code>ChannelOutboundInvoker.write(Object)</code>。</p> <div class="language- extra-class"><pre class="language-text"><code>                                              I/O Request
                                            via Channel or
                                        ChannelHandlerContext
                                                      |
  +---------------------------------------------------+---------------+
  |                           ChannelPipeline         |               |
  |                                                  \|/              |
  |    +---------------------+            +-----------+----------+    |
  |    | Inbound Handler  N  |            | Outbound Handler  1  |    |
  |    +----------+----------+            +-----------+----------+    |
  |              /|\                                  |               |
  |               |                                  \|/              |
  |    +----------+----------+            +-----------+----------+    |
  |    | Inbound Handler N-1 |            | Outbound Handler  2  |    |
  |    +----------+----------+            +-----------+----------+    |
  |              /|\                                  .               |
  |               .                                   .               |
  | ChannelHandlerContext.fireIN_EVT() ChannelHandlerContext.OUT_EVT()|
  |        [ method call]                       [method call]         |
  |               .                                   .               |
  |               .                                  \|/              |
  |    +----------+----------+            +-----------+----------+    |
  |    | Inbound Handler  2  |            | Outbound Handler M-1 |    |
  |    +----------+----------+            +-----------+----------+    |
  |              /|\                                  |               |
  |               |                                  \|/              |
  |    +----------+----------+            +-----------+----------+    |
  |    | Inbound Handler  1  |            | Outbound Handler  M  |    |
  |    +----------+----------+            +-----------+----------+    |
  |              /|\                                  |               |
  +---------------+-----------------------------------+---------------+
                  |                                  \|/
  +---------------+-----------------------------------+---------------+
  |               |                                   |               |
  |       [ Socket.read() ]                    [ Socket.write() ]     |
  |                                                                   |
  |  Netty Internal I/O Threads (Transport Implementation)            |
  +-------------------------------------------------------------------+
</code></pre></div><p>考虑下面这个pipeline：</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token class-name">ChannelPipeline</span> p <span class="token operator">=</span> <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">;</span>
 p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;1&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InboundHandlerA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;2&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InboundHandlerB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;3&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OutboundHandlerA</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;4&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">OutboundHandlerB</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 p<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;5&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">InboundOutboundHandlerX</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>如果来一个inbound event，执行顺序是1, 2, 5。如果来一个outbound event，执行顺序是5, 4, 3。</p> <h2 id="事件传播"><a href="#事件传播" class="header-anchor">#</a> 事件传播</h2> <p>Inbound event的传播方法有：</p> <ul><li>ChannelHandlerContext.fireChannelRegistered()</li> <li>ChannelHandlerContext.fireChannelActive()</li> <li>ChannelHandlerContext.fireChannelRead(Object)</li> <li>ChannelHandlerContext.fireChannelReadComplete()</li> <li>ChannelHandlerContext.fireExceptionCaught(Throwable)</li> <li>ChannelHandlerContext.fireUserEventTriggered(Object)</li> <li>ChannelHandlerContext.fireChannelWritabilityChanged()</li> <li>ChannelHandlerContext.fireChannelInactive()</li> <li>ChannelHandlerContext.fireChannelUnregistered()</li></ul> <p>Outbound event的传播方法有：</p> <ul><li>ChannelOutboundInvoker.bind(SocketAddress, ChannelPromise)</li> <li>ChannelOutboundInvoker.connect(SocketAddress, SocketAddress, ChannelPromise)</li> <li>ChannelOutboundInvoker.write(Object, ChannelPromise)</li> <li>ChannelHandlerContext.flush()</li> <li>ChannelHandlerContext.read()</li> <li>ChannelOutboundInvoker.disconnect(ChannelPromise)</li> <li>ChannelOutboundInvoker.close(ChannelPromise)</li> <li>ChannelOutboundInvoker.deregister(ChannelPromise)</li></ul> <p>下面的代码展示一般如何做事件传播：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyInboundHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>
      <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Connected!&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         ctx<span class="token punctuation">.</span><span class="token function">fireChannelActive</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>

 <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyOutboundHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelOutboundHandlerAdapter</span> <span class="token punctuation">{</span>
      <span class="token annotation punctuation">@Override</span>
     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">close</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token class-name">System</span><span class="token punctuation">.</span>out<span class="token punctuation">.</span><span class="token function">println</span><span class="token punctuation">(</span><span class="token string">&quot;Closing ..&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
         ctx<span class="token punctuation">.</span><span class="token function">close</span><span class="token punctuation">(</span>promise<span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
 <span class="token punctuation">}</span>
</code></pre></div><h2 id="创建pipeline"><a href="#创建pipeline" class="header-anchor">#</a> 创建pipeline</h2> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">EventExecutorGroup</span> group <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">DefaultEventExecutorGroup</span><span class="token punctuation">(</span><span class="token number">16</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>

 <span class="token class-name">ChannelPipeline</span> pipeline <span class="token operator">=</span> ch<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;decoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyProtocolDecoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
 pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;encoder&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyProtocolEncoder</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

 <span class="token comment">// Tell the pipeline to run MyBusinessLogicHandler's event handler methods</span>
 <span class="token comment">// in a different thread than an I/O thread so that the I/O thread is not blocked by</span>
 <span class="token comment">// a time-consuming task.</span>
 <span class="token comment">// If your business logic is fully asynchronous or finished very quickly, you don't</span>
 <span class="token comment">// need to specify a group.</span>
 pipeline<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token string">&quot;handler&quot;</span><span class="token punctuation">,</span> <span class="token keyword">new</span> <span class="token class-name">MyBusinessLogicHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><h2 id="channelhandlercontext介绍"><a href="#channelhandlercontext介绍" class="header-anchor">#</a> ChannelHandlerContext介绍</h2> <p>由于和pipeline源码学习强相关，这里先介绍ChannelHandlerContext。ChannelHandlerContext使ChannelHandler可以和ChannelPipeline以及别的handlers交互，既可以通知下一个handler，也可以在运行时动态的修改pipeline。从context的<code>pipeline()</code>返回值就可以得到pipeline。context可以用于存储状态信息，这在之前的文章(<a href="/source/netty/5.html">channel注册、适配器</a>-&gt;ChannelHandler详解-&gt;状态管理)也提到过。</p> <p>有时handler不止一个context，例如被多次加到pipeline时:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">FactorialHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelInboundHandlerAdapter</span> <span class="token punctuation">{</span>

<span class="token keyword">private</span> <span class="token keyword">final</span> <span class="token class-name">AttributeKey</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> counter <span class="token operator">=</span> <span class="token class-name">AttributeKey</span><span class="token punctuation">.</span><span class="token function">valueOf</span><span class="token punctuation">(</span><span class="token string">&quot;counter&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token comment">// This handler will receive a sequence of increasing integers starting</span>
<span class="token comment">// from 1.</span>
<span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">Integer</span> a <span class="token operator">=</span> ctx<span class="token punctuation">.</span><span class="token function">attr</span><span class="token punctuation">(</span>counter<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">if</span> <span class="token punctuation">(</span>a <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    a <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    attr<span class="token punctuation">.</span><span class="token function">set</span><span class="token punctuation">(</span>a <span class="token operator">*</span> <span class="token punctuation">(</span><span class="token class-name">Integer</span><span class="token punctuation">)</span> msg<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// Different context objects are given to &quot;f1&quot;, &quot;f2&quot;, &quot;f3&quot;, and &quot;f4&quot; even if</span>
<span class="token comment">// they refer to the same handler instance.  Because the FactorialHandler</span>
<span class="token comment">// stores its state in a context object (using an AttributeKey), the factorial is</span>
<span class="token comment">// calculated correctly 4 times once the two pipelines (p1 and p2) are active.</span>
<span class="token class-name">FactorialHandler</span> fh <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">FactorialHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ChannelPipeline</span> p1 <span class="token operator">=</span> <span class="token class-name">Channels</span><span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p1<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;f1&quot;</span><span class="token punctuation">,</span> fh<span class="token punctuation">)</span><span class="token punctuation">;</span>
p1<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;f2&quot;</span><span class="token punctuation">,</span> fh<span class="token punctuation">)</span><span class="token punctuation">;</span>

<span class="token class-name">ChannelPipeline</span> p2 <span class="token operator">=</span> <span class="token class-name">Channels</span><span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
p2<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;f3&quot;</span><span class="token punctuation">,</span> fh<span class="token punctuation">)</span><span class="token punctuation">;</span>
p2<span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span><span class="token string">&quot;f4&quot;</span><span class="token punctuation">,</span> fh<span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>可以把context存起来供后续使用，比如在handler的方法之外甚至另一个线程来触发事件：</p> <div class="language-java extra-class"><pre class="language-java"><code> <span class="token keyword">public</span> <span class="token keyword">class</span> <span class="token class-name">MyHandler</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelDuplexHandler</span> <span class="token punctuation">{</span>

     <span class="token keyword">private</span> <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">;</span>

     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">beforeAdd</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         <span class="token keyword">this</span><span class="token punctuation">.</span>ctx <span class="token operator">=</span> ctx<span class="token punctuation">;</span>
     <span class="token punctuation">}</span>

     <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">login</span><span class="token punctuation">(</span><span class="token class-name">String</span> username<span class="token punctuation">,</span> password<span class="token punctuation">)</span> <span class="token punctuation">{</span>
         ctx<span class="token punctuation">.</span><span class="token function">write</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">LoginMessage</span><span class="token punctuation">(</span>username<span class="token punctuation">,</span> password<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
     <span class="token punctuation">}</span>
     <span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span>
 <span class="token punctuation">}</span>
</code></pre></div><h2 id="pipeline源码学习"><a href="#pipeline源码学习" class="header-anchor">#</a> pipeline源码学习</h2> <p>最初看到pipeline，就猜想netty应该是用责任链模式来实现的，但对照类图<a href="/source/design-pattern/7.html">责任链模式</a>，如果说<code>ChannelHandler</code>是处理者，那它应该有<code>next</code>指向下一个<code>handler</code>才对，但是实际<code>ChannelHandler</code>只是一个接口，包括它的实现类如<code>ChannelInboundHandlerAdapter</code>都没有<code>next</code>成员。</p> <p>回顾本文开篇的那段代码，<code>pipeline</code>有<code>addLast</code>方法，看来<code>next</code>之类的逻辑应该在这里面。</p> <p><code>ChannelPipeline</code>继承了<code>ChannelInboundInvoker</code>、<code>ChannelOutboundInvoker</code>、<code>Iterable</code>三个接口，前两个是用来做事件传播的，实现<code>Iterable</code>接口对象才能支持<code>for-each loop</code>语法。它支持的方法可以分为三大类：</p> <ul><li>handler的增删查改方法：add、remove、replace、first、last等，普遍支持方向，比如addFirst、addLast。</li> <li>获取ChannelHandlerContext和Channel</li> <li>事件传播的方法：如fireChannelRegistered</li></ul> <p>ChannelPipeline的实现类是DefaultChannelPipeline，在这个类里终于看到了next相关的代码，例如成员变量:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> head<span class="token punctuation">;</span>
<span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> tail<span class="token punctuation">;</span>
</code></pre></div><p>还有构造函数：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">protected</span> <span class="token class-name">DefaultChannelPipeline</span><span class="token punctuation">(</span><span class="token class-name">Channel</span> channel<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">this</span><span class="token punctuation">.</span>channel <span class="token operator">=</span> <span class="token class-name">ObjectUtil</span><span class="token punctuation">.</span><span class="token function">checkNotNull</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token string">&quot;channel&quot;</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    succeededFuture <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">SucceededChannelFuture</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token keyword">null</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    voidPromise <span class="token operator">=</span>  <span class="token keyword">new</span> <span class="token class-name">VoidChannelPromise</span><span class="token punctuation">(</span>channel<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    tail <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">TailContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    head <span class="token operator">=</span> <span class="token keyword">new</span> <span class="token class-name">HeadContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>

    head<span class="token punctuation">.</span>next <span class="token operator">=</span> tail<span class="token punctuation">;</span>
    tail<span class="token punctuation">.</span>prev <span class="token operator">=</span> head<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>现在明确了AbstractChannelHandlerContext是责任链模式中的抽象处理者，但是和标准的责任链模式不一样的是，它内部不是一个处理方法，而是多个处理方法并且被封装到一个ChannelHandler实现类。它是双向链表结构，这一点也是和教科书上的责任链不同。</p></div> <p>我们在EchoServer里边添加handler时调用的就是<code>DefaultChannelPipeline.addLast()</code>方法：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandler</span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> handlers<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token keyword">null</span><span class="token punctuation">,</span> handlers<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>一直跟下去，可以看到创建context的代码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token function">newContext</span><span class="token punctuation">(</span><span class="token class-name">EventExecutorGroup</span> group<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">DefaultChannelHandlerContext</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">,</span> <span class="token function">childExecutor</span><span class="token punctuation">(</span>group<span class="token punctuation">)</span><span class="token punctuation">,</span> name<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><div class="custom-block tip"><p class="custom-block-title">TIP</p> <p>到这里明确了拥有实际handler的DefaultChannelHandlerContext是责任链模式的具体处理者。DefaultChannelPipeline是客户类。</p></div> <p>从netty如何使用责任链模式也再次说明实践会和教科书有些不一样，大部分情况都会根据实际做优化，这可能也是读源码的意义吧。</p> <h2 id="childhandler源码学习"><a href="#childhandler源码学习" class="header-anchor">#</a> childHandler源码学习</h2> <p><code>childHandler()</code>的入参是<code>ChannelHandler</code>，这里是创建了一个<code>ChannelInitializer</code>，但真正的处理逻辑其实是<code>serverHandler</code>，有点不好理解了。按一般想法，应该把<code>serverHandler</code>传给<code>childHandler()</code>才对。从这里往下找，最终找到是在<code>ServerBootstrapAcceptor.channelRead()</code>方法里边把<code>childHandler</code>加到了<code>pipeline</code>里：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 这个child是channel</span>
child<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>childHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token keyword">try</span> <span class="token punctuation">{</span>
    childGroup<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token function">forceClose</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> future<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>当某个<code>channel</code>有数据进来时就会回调<code>channelRead()</code>，这就把<code>childHandler</code>注册到了<code>pipeline</code>，再接下来<code>channel</code>会被注册到<code>workerGroup</code>，而根据<code>ChannelInitializer</code>里的注释，在<code>channel</code>注册的时候就会调<code>ChannelInitializer.handlerAdded()</code>把<code>serverHandler</code>加到管道。可以从<code>AbstractChannel.register0()</code>得到印证：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">// 只取了相关的一行代码</span>
pipeline<span class="token punctuation">.</span><span class="token function">invokeHandlerAddedIfNeeded</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>而在<code>ChannelInitializer</code>内部，存在</p> <p>handlerAdded() -&gt; initChannel(ChannelHandlerContext ctx) -&gt; initChannel(Channel ch)</p> <p>这样的调用关系，而且在initChannel(ChannelHandlerContext ctx)中还会把自己从pipeline中移除。最后调的这个initChannel(Channel ch)就是本文开头的那个代码了。</p> <p>整个过程搞明白了，留下一个世纪之问：为何要大费周章，不直接把serverHandler传进去呢？</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">2/23/2020, 5:20:21 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/source/netty/5.html" class="prev">
        netty源码学习-channel注册、适配器
      </a></span> <span class="next"><a href="/source/netty/7.html">
        netty源码学习-原型、模板方法
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d45e7d8d.js" defer></script><script src="/assets/js/3.f201c9f2.js" defer></script><script src="/assets/js/2.58f2d4b3.js" defer></script><script src="/assets/js/48.c9adb86a.js" defer></script>
  </body>
</html>
