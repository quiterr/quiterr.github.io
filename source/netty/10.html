<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>handler的生命周期 | quiterr的个人博客</title>
    <meta name="description" content="quiterr的个人博客">
    <link rel="icon" href="/assets/img/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.2fd3a0e5.css" as="style"><link rel="preload" href="/assets/js/app.d45e7d8d.js" as="script"><link rel="preload" href="/assets/js/3.f201c9f2.js" as="script"><link rel="preload" href="/assets/js/2.58f2d4b3.js" as="script"><link rel="preload" href="/assets/js/45.04e3bb01.js" as="script"><link rel="prefetch" href="/assets/js/10.8f6ff41b.js"><link rel="prefetch" href="/assets/js/11.d3060e6c.js"><link rel="prefetch" href="/assets/js/12.5d5dd355.js"><link rel="prefetch" href="/assets/js/13.b58b39cd.js"><link rel="prefetch" href="/assets/js/14.132da01d.js"><link rel="prefetch" href="/assets/js/15.4de3abff.js"><link rel="prefetch" href="/assets/js/16.5d01f151.js"><link rel="prefetch" href="/assets/js/17.743cc240.js"><link rel="prefetch" href="/assets/js/18.5cd47213.js"><link rel="prefetch" href="/assets/js/19.c31513f4.js"><link rel="prefetch" href="/assets/js/20.ff0c8b17.js"><link rel="prefetch" href="/assets/js/21.23bfd343.js"><link rel="prefetch" href="/assets/js/22.7b1bcdc8.js"><link rel="prefetch" href="/assets/js/23.9aa9bcc6.js"><link rel="prefetch" href="/assets/js/24.41feae7a.js"><link rel="prefetch" href="/assets/js/25.085c0a62.js"><link rel="prefetch" href="/assets/js/26.28112f5e.js"><link rel="prefetch" href="/assets/js/27.3dfa1162.js"><link rel="prefetch" href="/assets/js/28.64b59646.js"><link rel="prefetch" href="/assets/js/29.5da0daa7.js"><link rel="prefetch" href="/assets/js/30.e061c642.js"><link rel="prefetch" href="/assets/js/31.af9d5f01.js"><link rel="prefetch" href="/assets/js/32.3bb3cd16.js"><link rel="prefetch" href="/assets/js/33.28c6384b.js"><link rel="prefetch" href="/assets/js/34.e24d72db.js"><link rel="prefetch" href="/assets/js/35.066a2949.js"><link rel="prefetch" href="/assets/js/36.3605469b.js"><link rel="prefetch" href="/assets/js/37.0f0334ec.js"><link rel="prefetch" href="/assets/js/38.c4e1f427.js"><link rel="prefetch" href="/assets/js/39.bf835b74.js"><link rel="prefetch" href="/assets/js/4.130bd99d.js"><link rel="prefetch" href="/assets/js/40.df4753ea.js"><link rel="prefetch" href="/assets/js/41.c0060482.js"><link rel="prefetch" href="/assets/js/42.13e0dffa.js"><link rel="prefetch" href="/assets/js/43.2a7ba197.js"><link rel="prefetch" href="/assets/js/44.4a50ce9b.js"><link rel="prefetch" href="/assets/js/46.f860615e.js"><link rel="prefetch" href="/assets/js/47.57f7e152.js"><link rel="prefetch" href="/assets/js/48.c9adb86a.js"><link rel="prefetch" href="/assets/js/49.89d283b4.js"><link rel="prefetch" href="/assets/js/5.bc8341b3.js"><link rel="prefetch" href="/assets/js/50.176d29a8.js"><link rel="prefetch" href="/assets/js/51.73ee13f6.js"><link rel="prefetch" href="/assets/js/6.5dc22b3f.js"><link rel="prefetch" href="/assets/js/7.5d9116e6.js"><link rel="prefetch" href="/assets/js/8.ab4e4f3e.js"><link rel="prefetch" href="/assets/js/9.05f51b5b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2fd3a0e5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="quiterr的个人博客" class="logo"> <span class="site-name can-hide">quiterr的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://www.jianshu.com/u/e268fe04200a" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/quiterr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.hanclouds.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  hanclouds
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://www.jianshu.com/u/e268fe04200a" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/quiterr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.hanclouds.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  hanclouds
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/architecture/" class="sidebar-heading clickable"><span>架构设计</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/source/" class="sidebar-heading clickable router-link-active open"><span>源码阅读</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/source/netty/" class="sidebar-heading clickable router-link-active open"><span>netty源码学习</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/source/netty/" class="sidebar-link">netty源码学习-链式编程和建造者</a></li><li><a href="/source/netty/2.html" class="sidebar-link">netty源码学习-反射和工厂</a></li><li><a href="/source/netty/3.html" class="sidebar-link">netty源码学习-3种IO、Reactor</a></li><li><a href="/source/netty/4.html" class="sidebar-link">netty源码学习-多重继承、异步编程、观察者</a></li><li><a href="/source/netty/5.html" class="sidebar-link">netty源码学习-channel注册、适配器</a></li><li><a href="/source/netty/6.html" class="sidebar-link">netty源码学习-pipeline、责任链</a></li><li><a href="/source/netty/7.html" class="sidebar-link">netty源码学习-原型、模板方法</a></li><li><a href="/source/netty/8.html" class="sidebar-link">netty源码学习-粘包&amp;半包</a></li><li><a href="/source/netty/9.html" class="sidebar-link">keepalive 和 idle</a></li><li><a href="/source/netty/10.html" class="active sidebar-link">handler的生命周期</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/source/netty/10.html#handler生命周期及其实现原理" class="sidebar-link">handler生命周期及其实现原理</a></li><li class="sidebar-sub-header"><a href="/source/netty/10.html#channelhandlermask源码分析" class="sidebar-link">ChannelHandlerMask源码分析</a></li></ul></li><li><a href="/source/netty/11.html" class="sidebar-link">netty中的锁</a></li><li><a href="/source/netty/12.html" class="sidebar-link">netty如何使用内存</a></li><li><a href="/source/netty/13.html" class="sidebar-link">启动过程</a></li><li><a href="/source/netty/14.html" class="sidebar-link">创建连接</a></li></ul></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/source/jdk/" class="sidebar-heading clickable"><span>jdk源码阅读</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable is-sub-group depth-1"><a href="/source/quartz" class="sidebar-heading clickable"><span>quartz源码阅读</span> <span class="arrow right"></span></a> <!----></section></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/design-pattern/" class="sidebar-heading clickable"><span>设计模式</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/frontend/" class="sidebar-heading clickable"><span>前端开发</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/database/" class="sidebar-heading clickable"><span>数据库</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/collection/" class="sidebar-heading clickable"><span>资料收藏</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="handler的生命周期"><a href="#handler的生命周期" class="header-anchor">#</a> handler的生命周期</h1> <p>本文知识点：如何实现生命周期，isAssignableFrom方法，AccessController类，</p> <p></p><div class="table-of-contents"><ul><li><a href="#handler生命周期及其实现原理">handler生命周期及其实现原理</a></li><li><a href="#channelhandlermask源码分析">ChannelHandlerMask源码分析</a></li></ul></div><p></p> <h2 id="handler生命周期及其实现原理"><a href="#handler生命周期及其实现原理" class="header-anchor">#</a> handler生命周期及其实现原理</h2> <p>在<a href="/source/netty/5.html">channel注册、适配器</a>这一节介绍了ChannelHandler，在<a href="/source/netty/6.html">pipeline、责任链</a>这一节介绍了ChannelHandlerContext，但是还没有把两者联系起来，特别是没有从源码角度理解ChannelHandler的生命周期是如何实现的。</p> <p>ChannelHandler的生命周期，贴一些该接口的源码就明白了：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
    * Gets called after the {@link ChannelHandler} was added to the actual context and it's ready to handle events.
    */</span>
<span class="token keyword">void</span> <span class="token function">handlerAdded</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

<span class="token comment">/**
    * Gets called after the {@link ChannelHandler} was removed from the actual context and it doesn't handle events
    * anymore.
    */</span>
<span class="token keyword">void</span> <span class="token function">handlerRemoved</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

<span class="token comment">// 其他代码省略</span>
</code></pre></div><p>ChannelInboundHandler接口的部分源码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
    * The {@link Channel} of the {@link ChannelHandlerContext} was registered with its {@link EventLoop}
    */</span>
<span class="token keyword">void</span> <span class="token function">channelRegistered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

<span class="token comment">/**
    * The {@link Channel} of the {@link ChannelHandlerContext} was unregistered from its {@link EventLoop}
    */</span>
<span class="token keyword">void</span> <span class="token function">channelUnregistered</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

<span class="token comment">/**
    * The {@link Channel} of the {@link ChannelHandlerContext} is now active
    */</span>
<span class="token keyword">void</span> <span class="token function">channelActive</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>

<span class="token comment">// 其他代码省略</span>
</code></pre></div><p>ChannelOutboundHandler接口的部分源码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">void</span> <span class="token function">bind</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">connect</span><span class="token punctuation">(</span>
            <span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">SocketAddress</span> remoteAddress<span class="token punctuation">,</span>
            <span class="token class-name">SocketAddress</span> localAddress<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token keyword">void</span> <span class="token function">disconnect</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span> promise<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span><span class="token punctuation">;</span>
<span class="token comment">// 其他代码省略</span>
</code></pre></div><p>那么生命周期是怎么实现的？有两个思路来分析：</p> <ul><li>用idea的find usage功能，很容易找到是AbstractChannelHandlerContext在调handlerAdded方法，因此要阅读AbstractChannelHandlerContext的代码。</li> <li>从ServerBootstrap的初始化一步一步追踪handler是怎么处理的。</li></ul> <p>用<a href="/source/netty/5.html">channel注册、适配器</a>中分析child channel注册的方法，很容易就找到child handler是怎么添加进pipeline的，其实这两块逻辑都在ServerBootstrap的内部类ServerBootstrapAcceptor：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token annotation punctuation">@SuppressWarnings</span><span class="token punctuation">(</span><span class="token string">&quot;unchecked&quot;</span><span class="token punctuation">)</span>
<span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">channelRead</span><span class="token punctuation">(</span><span class="token class-name">ChannelHandlerContext</span> ctx<span class="token punctuation">,</span> <span class="token class-name">Object</span> msg<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">Channel</span> child <span class="token operator">=</span> <span class="token punctuation">(</span><span class="token class-name">Channel</span><span class="token punctuation">)</span> msg<span class="token punctuation">;</span>
    <span class="token comment">// 添加childHandler</span>
    child<span class="token punctuation">.</span><span class="token function">pipeline</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addLast</span><span class="token punctuation">(</span>childHandler<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token function">setChannelOptions</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> childOptions<span class="token punctuation">,</span> logger<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token function">setAttributes</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> childAttrs<span class="token punctuation">)</span><span class="token punctuation">;</span>

    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token comment">// 注册child channel</span>
        childGroup<span class="token punctuation">.</span><span class="token function">register</span><span class="token punctuation">(</span>child<span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">addListener</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">ChannelFutureListener</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">operationComplete</span><span class="token punctuation">(</span><span class="token class-name">ChannelFuture</span> future<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
                <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>future<span class="token punctuation">.</span><span class="token function">isSuccess</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                    <span class="token function">forceClose</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> future<span class="token punctuation">.</span><span class="token function">cause</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token punctuation">}</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">forceClose</span><span class="token punctuation">(</span>child<span class="token punctuation">,</span> t<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>从这行代码<code>child.pipeline().addLast(childHandler);</code>跟下去，在DefaultChannelPipeline类中发现：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">addLast</span><span class="token punctuation">(</span><span class="token class-name">EventExecutorGroup</span> group<span class="token punctuation">,</span> <span class="token class-name">String</span> name<span class="token punctuation">,</span> <span class="token class-name">ChannelHandler</span> handler<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> newCtx<span class="token punctuation">;</span>
    <span class="token keyword">synchronized</span> <span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token function">checkMultiplicity</span><span class="token punctuation">(</span>handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

        newCtx <span class="token operator">=</span> <span class="token function">newContext</span><span class="token punctuation">(</span>group<span class="token punctuation">,</span> <span class="token function">filterName</span><span class="token punctuation">(</span>name<span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">,</span> handler<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token function">addLast0</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>

        <span class="token comment">// If the registered is false it means that the channel was not registered on an eventLoop yet.</span>
        <span class="token comment">// In this case we add the context to the pipeline and add a task that will call</span>
        <span class="token comment">// ChannelHandler.handlerAdded(...) once the channel is registered.</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>registered<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            newCtx<span class="token punctuation">.</span><span class="token function">setAddPending</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token function">callHandlerCallbackLater</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">,</span> <span class="token boolean">true</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>

        <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> newCtx<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token operator">!</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">callHandlerAddedInEventLoop</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">,</span> executor<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span>
    <span class="token function">callHandlerAdded0</span><span class="token punctuation">(</span>newCtx<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p><code>newCtx = newContext(group, filterName(name, handler), handler);</code>这行代码把handler传给了context。</p> <p>一个请求对应着一个channel，channel有自己的pipeline，pipeline中每一个处理者都是DefaultChannelHandlerContext，DefaultChannelHandlerContext持有handler，所以channel中有任何的事件发生，都能传导到handler了。其中第一个事件就是上面贴的addLast方法中的<code>callHandlerAdded0(newCtx);</code>，也就是添加handler。再以channel注册事件为例，最开始是AbstractChannel：</p> <div class="language-java extra-class"><pre class="language-java"><code>pipeline<span class="token punctuation">.</span><span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
</code></pre></div><p>接着是DefaultChannelPipeline，从head开始调用：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token keyword">final</span> <span class="token class-name">ChannelPipeline</span> <span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AbstractChannelHandlerContext</span><span class="token punctuation">.</span><span class="token function">invokeChannelRegistered</span><span class="token punctuation">(</span>head<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>最后是AbstractChannelHandlerContext：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token annotation punctuation">@Override</span>
<span class="token keyword">public</span> <span class="token class-name">ChannelHandlerContext</span> <span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token function">invokeChannelRegistered</span><span class="token punctuation">(</span><span class="token function">findContextInbound</span><span class="token punctuation">(</span>MASK_CHANNEL_REGISTERED<span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>

<span class="token keyword">static</span> <span class="token keyword">void</span> <span class="token function">invokeChannelRegistered</span><span class="token punctuation">(</span><span class="token keyword">final</span> <span class="token class-name">AbstractChannelHandlerContext</span> next<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">EventExecutor</span> executor <span class="token operator">=</span> next<span class="token punctuation">.</span><span class="token function">executor</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>executor<span class="token punctuation">.</span><span class="token function">inEventLoop</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        next<span class="token punctuation">.</span><span class="token function">invokeChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        executor<span class="token punctuation">.</span><span class="token function">execute</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">Runnable</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">public</span> <span class="token keyword">void</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                next<span class="token punctuation">.</span><span class="token function">invokeChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>

<span class="token comment">// 如果该自己执行，就调handler的channelRegistered方法，否则直接抛出事件给下一个context</span>
<span class="token keyword">private</span> <span class="token keyword">void</span> <span class="token function">invokeChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">invokeHandler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token keyword">try</span> <span class="token punctuation">{</span>
            <span class="token punctuation">(</span><span class="token punctuation">(</span><span class="token class-name">ChannelInboundHandler</span><span class="token punctuation">)</span> <span class="token function">handler</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">)</span><span class="token punctuation">.</span><span class="token function">channelRegistered</span><span class="token punctuation">(</span><span class="token keyword">this</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Throwable</span> t<span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token function">notifyHandlerException</span><span class="token punctuation">(</span>t<span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">else</span> <span class="token punctuation">{</span>
        <span class="token function">fireChannelRegistered</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
<span class="token punctuation">}</span>
</code></pre></div><p>多提一句怎么找下一个context的，也就是这行代码<code>findContextInbound(MASK_CHANNEL_REGISTERED)</code>:</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token class-name">AbstractChannelHandlerContext</span> <span class="token function">findContextInbound</span><span class="token punctuation">(</span><span class="token keyword">int</span> mask<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token class-name">AbstractChannelHandlerContext</span> ctx <span class="token operator">=</span> <span class="token keyword">this</span><span class="token punctuation">;</span>
    <span class="token keyword">do</span> <span class="token punctuation">{</span>
        ctx <span class="token operator">=</span> ctx<span class="token punctuation">.</span>next<span class="token punctuation">;</span>
    <span class="token punctuation">}</span> <span class="token keyword">while</span> <span class="token punctuation">(</span><span class="token punctuation">(</span>ctx<span class="token punctuation">.</span>executionMask <span class="token operator">&amp;</span> mask<span class="token punctuation">)</span> <span class="token operator">==</span> <span class="token number">0</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">return</span> ctx<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>可以看到只要<code>(ctx.executionMask &amp; mask) == 0</code>为true就会一直找下一个context，下一小节会介绍mask。</p> <h2 id="channelhandlermask源码分析"><a href="#channelhandlermask源码分析" class="header-anchor">#</a> ChannelHandlerMask源码分析</h2> <p>在AbstractChannelHandlerContext的构造函数中，<code>this.executionMask = mask(handlerClass);</code>这行代码把handler包装成了ChannelHandlerMask，下面逐步来看它的源码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_EXCEPTION_CAUGHT <span class="token operator">=</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_CHANNEL_REGISTERED <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">1</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_CHANNEL_UNREGISTERED <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">2</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_CHANNEL_ACTIVE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">3</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_CHANNEL_INACTIVE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">4</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_CHANNEL_READ <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">5</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_CHANNEL_READ_COMPLETE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">6</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_USER_EVENT_TRIGGERED <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">7</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_CHANNEL_WRITABILITY_CHANGED <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">8</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_BIND <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">9</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_CONNECT <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">10</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_DISCONNECT <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">11</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_CLOSE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">12</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_DEREGISTER <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">13</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_READ <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">14</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_WRITE <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">15</span><span class="token punctuation">;</span>
<span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_FLUSH <span class="token operator">=</span> <span class="token number">1</span> <span class="token operator">&lt;&lt;</span> <span class="token number">16</span><span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_ALL_INBOUND <span class="token operator">=</span> MASK_EXCEPTION_CAUGHT <span class="token operator">|</span> MASK_CHANNEL_REGISTERED <span class="token operator">|</span>
        MASK_CHANNEL_UNREGISTERED <span class="token operator">|</span> MASK_CHANNEL_ACTIVE <span class="token operator">|</span> MASK_CHANNEL_INACTIVE <span class="token operator">|</span> MASK_CHANNEL_READ <span class="token operator">|</span>
        MASK_CHANNEL_READ_COMPLETE <span class="token operator">|</span> MASK_USER_EVENT_TRIGGERED <span class="token operator">|</span> MASK_CHANNEL_WRITABILITY_CHANGED<span class="token punctuation">;</span>
<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token keyword">int</span> MASK_ALL_OUTBOUND <span class="token operator">=</span> MASK_EXCEPTION_CAUGHT <span class="token operator">|</span> MASK_BIND <span class="token operator">|</span> MASK_CONNECT <span class="token operator">|</span> MASK_DISCONNECT <span class="token operator">|</span>
        MASK_CLOSE <span class="token operator">|</span> MASK_DEREGISTER <span class="token operator">|</span> MASK_READ <span class="token operator">|</span> MASK_WRITE <span class="token operator">|</span> MASK_FLUSH<span class="token punctuation">;</span>

<span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">final</span> <span class="token class-name">FastThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span> MASKS <span class="token operator">=</span>
        <span class="token keyword">new</span> <span class="token class-name">FastThreadLocal</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Map</span><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            <span class="token annotation punctuation">@Override</span>
            <span class="token keyword">protected</span> <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> <span class="token function">initialValue</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                <span class="token keyword">return</span> <span class="token keyword">new</span> <span class="token class-name">WeakHashMap</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token number">32</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
        <span class="token punctuation">}</span><span class="token punctuation">;</span>
</code></pre></div><p>以上是ChannelHandlerMask的成员变量，先是定义了一系列元mask（每种情况占1bit位），接着是组合mask（MASK_ALL_INBOUND和MASK_ALL_OUTBOUND），最后是FastThreadLocal类型的map（key是handler，value是mask）。</p> <p>根据handler来获取mask值的方法，先从缓存取，取不到就计算并缓存：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token comment">/**
    * Return the {@code executionMask}.
    */</span>
<span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mask</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span></span> clazz<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token comment">// Try to obtain the mask from the cache first. If this fails calculate it and put it in the cache for fast</span>
    <span class="token comment">// lookup in the future.</span>
    <span class="token class-name">Map</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Class</span><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span><span class="token punctuation">,</span> <span class="token class-name">Integer</span><span class="token punctuation">&gt;</span></span> cache <span class="token operator">=</span> MASKS<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token class-name">Integer</span> mask <span class="token operator">=</span> cache<span class="token punctuation">.</span><span class="token function">get</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token keyword">if</span> <span class="token punctuation">(</span>mask <span class="token operator">==</span> <span class="token keyword">null</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        mask <span class="token operator">=</span> <span class="token function">mask0</span><span class="token punctuation">(</span>clazz<span class="token punctuation">)</span><span class="token punctuation">;</span>
        cache<span class="token punctuation">.</span><span class="token function">put</span><span class="token punctuation">(</span>clazz<span class="token punctuation">,</span> mask<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>
    <span class="token keyword">return</span> mask<span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>mask0的源码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">int</span> <span class="token function">mask0</span><span class="token punctuation">(</span><span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span> <span class="token keyword">extends</span> <span class="token class-name">ChannelHandler</span><span class="token punctuation">&gt;</span></span> handlerType<span class="token punctuation">)</span> <span class="token punctuation">{</span>
    <span class="token keyword">int</span> mask <span class="token operator">=</span> MASK_EXCEPTION_CAUGHT<span class="token punctuation">;</span>
    <span class="token keyword">try</span> <span class="token punctuation">{</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ChannelInboundHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mask <span class="token operator">|=</span> MASK_ALL_INBOUND<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;channelRegistered&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span>MASK_CHANNEL_REGISTERED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;channelUnregistered&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span>MASK_CHANNEL_UNREGISTERED<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 省略一堆if</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token class-name">ChannelOutboundHandler</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">.</span><span class="token function">isAssignableFrom</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mask <span class="token operator">|=</span> MASK_ALL_OUTBOUND<span class="token punctuation">;</span>

            <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;bind&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span>
                    <span class="token class-name">SocketAddress</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">ChannelPromise</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
                mask <span class="token operator">&amp;=</span> <span class="token operator">~</span>MASK_BIND<span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token comment">// 省略一堆if</span>
        <span class="token punctuation">}</span>
        <span class="token keyword">if</span> <span class="token punctuation">(</span><span class="token function">isSkippable</span><span class="token punctuation">(</span>handlerType<span class="token punctuation">,</span> <span class="token string">&quot;exceptionCaught&quot;</span><span class="token punctuation">,</span> <span class="token class-name">ChannelHandlerContext</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">,</span> <span class="token class-name">Throwable</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
            mask <span class="token operator">&amp;=</span> <span class="token operator">~</span>MASK_EXCEPTION_CAUGHT<span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">Exception</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token comment">// Should never reach here.</span>
        <span class="token class-name">PlatformDependent</span><span class="token punctuation">.</span><span class="token function">throwException</span><span class="token punctuation">(</span>e<span class="token punctuation">)</span><span class="token punctuation">;</span>
    <span class="token punctuation">}</span>

    <span class="token keyword">return</span> mask<span class="token punctuation">;</span>
<span class="token punctuation">}</span>        
</code></pre></div><p>mask0方法通过反射的方式，判断handler是否有channelRegistered等方法并设置mask，反射的逻辑在isSkippable方法中。这里用到了isAssignableFrom方法，以前还没有见过。isSkippable方法源码：</p> <div class="language-java extra-class"><pre class="language-java"><code><span class="token keyword">private</span> <span class="token keyword">static</span> <span class="token keyword">boolean</span> <span class="token function">isSkippable</span><span class="token punctuation">(</span>
        <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span> handlerType<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">String</span> methodName<span class="token punctuation">,</span> <span class="token keyword">final</span> <span class="token class-name">Class</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token operator">?</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">.</span><span class="token punctuation">.</span><span class="token punctuation">.</span> paramTypes<span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
    <span class="token keyword">return</span> <span class="token class-name">AccessController</span><span class="token punctuation">.</span><span class="token function">doPrivileged</span><span class="token punctuation">(</span><span class="token keyword">new</span> <span class="token class-name">PrivilegedExceptionAction</span><span class="token generics"><span class="token punctuation">&lt;</span><span class="token class-name">Boolean</span><span class="token punctuation">&gt;</span></span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token punctuation">{</span>
        <span class="token annotation punctuation">@Override</span>
        <span class="token keyword">public</span> <span class="token class-name">Boolean</span> <span class="token function">run</span><span class="token punctuation">(</span><span class="token punctuation">)</span> <span class="token keyword">throws</span> <span class="token class-name">Exception</span> <span class="token punctuation">{</span>
            <span class="token class-name">Method</span> m<span class="token punctuation">;</span>
            <span class="token keyword">try</span> <span class="token punctuation">{</span>
                m <span class="token operator">=</span> handlerType<span class="token punctuation">.</span><span class="token function">getMethod</span><span class="token punctuation">(</span>methodName<span class="token punctuation">,</span> paramTypes<span class="token punctuation">)</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span> <span class="token keyword">catch</span> <span class="token punctuation">(</span><span class="token class-name">NoSuchMethodException</span> e<span class="token punctuation">)</span> <span class="token punctuation">{</span>
                logger<span class="token punctuation">.</span><span class="token function">debug</span><span class="token punctuation">(</span>
                    <span class="token string">&quot;Class {} missing method {}, assume we can not skip execution&quot;</span><span class="token punctuation">,</span> handlerType<span class="token punctuation">,</span> methodName<span class="token punctuation">,</span> e<span class="token punctuation">)</span><span class="token punctuation">;</span>
                <span class="token keyword">return</span> <span class="token boolean">false</span><span class="token punctuation">;</span>
            <span class="token punctuation">}</span>
            <span class="token keyword">return</span> m <span class="token operator">!=</span> <span class="token keyword">null</span> <span class="token operator">&amp;&amp;</span> m<span class="token punctuation">.</span><span class="token function">isAnnotationPresent</span><span class="token punctuation">(</span><span class="token class-name">Skip</span><span class="token punctuation">.</span><span class="token keyword">class</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
        <span class="token punctuation">}</span>
    <span class="token punctuation">}</span><span class="token punctuation">)</span><span class="token punctuation">;</span>
<span class="token punctuation">}</span>
</code></pre></div><p>除了判断是否存在方法，isSkippable还会判断方法上是否有@Skip注解，如果有的话该方法会被跳过，mask上也不会有标记。@Skip注解也是定义在ChannelHandlerMask类中，ChannelInboundHandlerAdapter、ChannelDuplexHandler这两个抽象类的所有方法都被标记了@Skip，也就是期望子类重写，否则会跳过执行。这里用到了AccessController类，这是以前没有见过的。</p> <p>ChannelHandlerMask只是一个工具类，并没有用到装饰者子类的设计模式，这一点要明确。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">4/2/2020, 10:20:33 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/source/netty/9.html" class="prev">
        keepalive 和 idle
      </a></span> <span class="next"><a href="/source/netty/11.html">
        netty中的锁
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d45e7d8d.js" defer></script><script src="/assets/js/3.f201c9f2.js" defer></script><script src="/assets/js/2.58f2d4b3.js" defer></script><script src="/assets/js/45.04e3bb01.js" defer></script>
  </body>
</html>
