<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>一致性hash和redis集群 | quiterr的个人博客</title>
    <meta name="description" content="quiterr的个人博客">
    <link rel="icon" href="/assets/img/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.2fd3a0e5.css" as="style"><link rel="preload" href="/assets/js/app.d45e7d8d.js" as="script"><link rel="preload" href="/assets/js/3.f201c9f2.js" as="script"><link rel="preload" href="/assets/js/2.58f2d4b3.js" as="script"><link rel="preload" href="/assets/js/8.ab4e4f3e.js" as="script"><link rel="prefetch" href="/assets/js/10.8f6ff41b.js"><link rel="prefetch" href="/assets/js/11.d3060e6c.js"><link rel="prefetch" href="/assets/js/12.5d5dd355.js"><link rel="prefetch" href="/assets/js/13.b58b39cd.js"><link rel="prefetch" href="/assets/js/14.132da01d.js"><link rel="prefetch" href="/assets/js/15.4de3abff.js"><link rel="prefetch" href="/assets/js/16.5d01f151.js"><link rel="prefetch" href="/assets/js/17.743cc240.js"><link rel="prefetch" href="/assets/js/18.5cd47213.js"><link rel="prefetch" href="/assets/js/19.c31513f4.js"><link rel="prefetch" href="/assets/js/20.ff0c8b17.js"><link rel="prefetch" href="/assets/js/21.23bfd343.js"><link rel="prefetch" href="/assets/js/22.7b1bcdc8.js"><link rel="prefetch" href="/assets/js/23.9aa9bcc6.js"><link rel="prefetch" href="/assets/js/24.41feae7a.js"><link rel="prefetch" href="/assets/js/25.085c0a62.js"><link rel="prefetch" href="/assets/js/26.28112f5e.js"><link rel="prefetch" href="/assets/js/27.3dfa1162.js"><link rel="prefetch" href="/assets/js/28.64b59646.js"><link rel="prefetch" href="/assets/js/29.5da0daa7.js"><link rel="prefetch" href="/assets/js/30.e061c642.js"><link rel="prefetch" href="/assets/js/31.af9d5f01.js"><link rel="prefetch" href="/assets/js/32.3bb3cd16.js"><link rel="prefetch" href="/assets/js/33.28c6384b.js"><link rel="prefetch" href="/assets/js/34.e24d72db.js"><link rel="prefetch" href="/assets/js/35.066a2949.js"><link rel="prefetch" href="/assets/js/36.3605469b.js"><link rel="prefetch" href="/assets/js/37.0f0334ec.js"><link rel="prefetch" href="/assets/js/38.c4e1f427.js"><link rel="prefetch" href="/assets/js/39.bf835b74.js"><link rel="prefetch" href="/assets/js/4.130bd99d.js"><link rel="prefetch" href="/assets/js/40.df4753ea.js"><link rel="prefetch" href="/assets/js/41.c0060482.js"><link rel="prefetch" href="/assets/js/42.13e0dffa.js"><link rel="prefetch" href="/assets/js/43.2a7ba197.js"><link rel="prefetch" href="/assets/js/44.4a50ce9b.js"><link rel="prefetch" href="/assets/js/45.04e3bb01.js"><link rel="prefetch" href="/assets/js/46.f860615e.js"><link rel="prefetch" href="/assets/js/47.57f7e152.js"><link rel="prefetch" href="/assets/js/48.c9adb86a.js"><link rel="prefetch" href="/assets/js/49.89d283b4.js"><link rel="prefetch" href="/assets/js/5.bc8341b3.js"><link rel="prefetch" href="/assets/js/50.176d29a8.js"><link rel="prefetch" href="/assets/js/51.73ee13f6.js"><link rel="prefetch" href="/assets/js/6.5dc22b3f.js"><link rel="prefetch" href="/assets/js/7.5d9116e6.js"><link rel="prefetch" href="/assets/js/9.05f51b5b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2fd3a0e5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="quiterr的个人博客" class="logo"> <span class="site-name can-hide">quiterr的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://www.jianshu.com/u/e268fe04200a" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/quiterr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.hanclouds.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  hanclouds
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://www.jianshu.com/u/e268fe04200a" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/quiterr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.hanclouds.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  hanclouds
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/architecture/" class="sidebar-heading clickable"><span>架构设计</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/source/" class="sidebar-heading clickable"><span>源码阅读</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/design-pattern/" class="sidebar-heading clickable"><span>设计模式</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/frontend/" class="sidebar-heading clickable"><span>前端开发</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/database/" class="sidebar-heading clickable router-link-active open"><span>数据库</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/database/" class="sidebar-link">《Elasticsearch权威指南》随笔</a></li><li><a href="/database/mongodb.html" class="sidebar-link">MongoDB分片介绍</a></li><li><a href="/database/redis.html" class="active sidebar-link">一致性hash和redis集群</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/database/redis.html#问题描述" class="sidebar-link">问题描述</a></li><li class="sidebar-sub-header"><a href="/database/redis.html#一致性hash" class="sidebar-link">一致性hash</a></li><li class="sidebar-sub-header"><a href="/database/redis.html#redis集群" class="sidebar-link">redis集群</a></li></ul></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/collection/" class="sidebar-heading clickable"><span>资料收藏</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="一致性hash和redis集群"><a href="#一致性hash和redis集群" class="header-anchor">#</a> 一致性hash和redis集群</h1> <p></p><div class="table-of-contents"><ul><li><a href="#问题描述">问题描述</a></li><li><a href="#一致性hash">一致性hash</a></li><li><a href="#redis集群">redis集群</a></li></ul></div><p></p> <h2 id="问题描述"><a href="#问题描述" class="header-anchor">#</a> 问题描述</h2> <p>集群场景下，由哪个机器提供服务需要一个负载均衡算法。微服务场景的负载均衡算法一般采用轮询。缓存场景下，一般是采用hash算法，假设有5台服务器，数据hashCode是9，9对5取模是4，那么这个数据就会在编号4的机器上存取。</p> <p>但是当有服务器宕机和新服务器加入时，存在缓存大量失效的问题。仍然是上面的例子，假如1号机器宕机，还剩4台机器（重新编号为1到4），同样的数据对4取模后为1，那数据的存取会从原来的4号机转为原来2号机（重新编号后为1）。整个系统的缓存都面临失效的困境。</p> <h2 id="一致性hash"><a href="#一致性hash" class="header-anchor">#</a> 一致性hash</h2> <p>下文参考了<a href="https://blog.csdn.net/u013851082/article/details/68063446" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/u013851082/article/details/68063446<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>一致性hash正是为了解决缓存失效的问题。</p> <p><strong>1、环形桶</strong></p> <p>按照常用的hash算法来将对应的key哈希到一个具有2^32个桶的空间中，即0~(2^32)-1的数字空间中。可以将这些数字头尾相连，想象成一个闭合的环形。</p> <p><img src="data:image/png;base64,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" alt=""></p> <p><strong>2、把数据通过一定的hash算法处理后映射到环上</strong></p> <p>将object1、object2、object3、object4四个对象通过特定的Hash函数计算出对应的key值，然后散列到Hash环上。如下图：</p> <p>Hash(object1) = key1；</p> <p>Hash(object2) = key2；</p> <p>Hash(object3) = key3；</p> <p>Hash(object4) = key4；</p> <p><img src="/assets/img/hash2.a67b7d29.png" alt=""></p> <p><strong>3、将机器通过hash算法映射到环上</strong></p> <p>在集群中将机器通过使用与对象存储一样的Hash算法也映射到环中，然后以顺时针的方向计算，将所有对象存储到离自己最近的机器中。
假设现在有NODE1，NODE2，NODE3三台机器，通过Hash算法得到对应的KEY值，映射到环中，其示意图如下：</p> <p>Hash(NODE1) = KEY1;</p> <p>Hash(NODE2) = KEY2;</p> <p>Hash(NODE3) = KEY3;</p> <p><img src="/assets/img/hash3.ddea9dde.png" alt=""></p> <p><strong>4、节点（机器）的删除</strong></p> <p>如果NODE2出现故障被删除了，那么按照顺时针迁移的方法，object3将会被迁移到NODE3中，这样仅仅是object3的映射位置发生了变化，其它的对象没有任何的改动。如下图：</p> <p><img src="/assets/img/hash4.498c3735.png" alt=""></p> <p><strong>5、节点（机器）的添加</strong></p> <p>如果往集群中添加一个新的节点NODE4，通过对应的哈希算法得到KEY4，并映射到环中，如下图：</p> <p><img src="/assets/img/hash5.6fd6f89e.png" alt=""></p> <p>通过按顺时针迁移的规则，那么object2被迁移到了NODE4中，其它对象还保持这原有的存储位置。</p> <p>通过对节点的添加和删除的分析，一致性哈希算法在保持了单调性的同时，还是数据的迁移达到了最小，这样的算法对分布式集群来说是非常合适的，避免了大量数据迁移，减小了服务器的的压力。</p> <p><strong>6、平衡性</strong></p> <p>在NODE2被删除的图中，object1存储到了NODE1中，而object2、object3、object4都存储到了NODE3中，这样负载不均衡。</p> <p>在一致性哈希算法中，为了尽可能的满足平衡性，其引入了虚拟节点。“虚拟节点”（ virtual node ）是实际节点（机器）在 hash 空间的复制品（replica），一实际个节点（机器）对应了若干个“虚拟节点”，这个对应个数也成为“复制个数”。</p> <p>图中的蓝色节点都是虚拟节点，机器A负载存储A1、A2的数据，机器B负载存储B1、B2的数据，机器C负载存储C1、C2的数据。由于这些虚拟节点数量很多，均匀分布，因此不会造成“雪崩”现象。</p> <p><img src="/assets/img/hash6.54d912e6.gif" alt=""></p> <p>使用虚拟节点的思想，为每个物理节点（服务器）在圆上分配100～200个点。这样就能抑制分布不均匀，最大限度地减小服务器增减时的缓存重新分布。用户数据映射在虚拟节点上，就表示用户数据真正存储位置是在该虚拟节点代表的实际物理服务器上。
下面有一个图描述了需要为每台物理服务器增加的虚拟节点。</p> <p><img src="/assets/img/hash7.44eac425.png" alt=""></p> <p>轴表示的是需要为每台物理服务器扩展的虚拟节点倍数(scale)，y轴是实际物理服务器数，可以看出，当物理服务器的数量很小时，需要更大的虚拟节点，反之则需要更少的节点，从图上可以看出，在物理服务器有10台时，差不多需要为每台服务器增加100~200个虚拟节点才能达到真正的负载均衡。</p> <h2 id="redis集群"><a href="#redis集群" class="header-anchor">#</a> redis集群</h2> <p>上面介绍了这么多一致性hash算法，但redis集群并没有采用这个算法。</p> <p>下文参考了：</p> <p><a href="https://blog.csdn.net/llianlianpay/article/details/79768303" target="_blank" rel="noopener noreferrer">https://blog.csdn.net/llianlianpay/article/details/79768303<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p><a href="http://www.redis.cn/topics/cluster-tutorial.html" target="_blank" rel="noopener noreferrer">http://www.redis.cn/topics/cluster-tutorial.html<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>Redis Cluster是一种服务器Sharding技术，3.0版本开始正式提供。</p> <p>Redis Cluster中，Sharding采用slot(槽)的概念，一共分成16384个槽，这有点儿类pre sharding思路。对于每个进入Redis的键值对，根据key进行散列，分配到这16384个slot中的某一个中。使用的hash算法也比较简单，就是CRC16后16384取模。</p> <p>这种结构很容易添加或者删除节点. 比如如果我想新添加个节点D, 我需要从节点 A, B, C中得部分槽到D上. 如果我想移除节点A,需要将A中的槽移到B和C节点上,然后将没有任何槽的A节点从集群中移除即可. 由于从一个节点将哈希槽移动到另一个节点并不会停止服务,所以无论添加删除或者改变某个节点的哈希槽的数量都不会造成集群不可用的状态.</p> <p>由于只是移动部分哈希槽，不会造成缓存大量失效。实际生产环境，可能更多的是扩容添加节点，删除节点不大可能发生，有节点宕机同样不大可能（因为集群要求每个节点都有复制集）。</p></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">5/9/2020, 6:18:14 PM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/database/mongodb.html" class="prev">
        MongoDB分片介绍
      </a></span> <span class="next"><a href="/collection/">
        资料收藏
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d45e7d8d.js" defer></script><script src="/assets/js/3.f201c9f2.js" defer></script><script src="/assets/js/2.58f2d4b3.js" defer></script><script src="/assets/js/8.ab4e4f3e.js" defer></script>
  </body>
</html>
