<!DOCTYPE html>
<html lang="en-US">
  <head>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width,initial-scale=1">
    <title>Nginx笔记 | quiterr的个人博客</title>
    <meta name="description" content="quiterr的个人博客">
    <link rel="icon" href="/assets/img/logo.png">
    
    <link rel="preload" href="/assets/css/0.styles.2fd3a0e5.css" as="style"><link rel="preload" href="/assets/js/app.d45e7d8d.js" as="script"><link rel="preload" href="/assets/js/3.f201c9f2.js" as="script"><link rel="preload" href="/assets/js/2.58f2d4b3.js" as="script"><link rel="preload" href="/assets/js/37.0f0334ec.js" as="script"><link rel="prefetch" href="/assets/js/10.8f6ff41b.js"><link rel="prefetch" href="/assets/js/11.d3060e6c.js"><link rel="prefetch" href="/assets/js/12.5d5dd355.js"><link rel="prefetch" href="/assets/js/13.b58b39cd.js"><link rel="prefetch" href="/assets/js/14.132da01d.js"><link rel="prefetch" href="/assets/js/15.4de3abff.js"><link rel="prefetch" href="/assets/js/16.5d01f151.js"><link rel="prefetch" href="/assets/js/17.743cc240.js"><link rel="prefetch" href="/assets/js/18.5cd47213.js"><link rel="prefetch" href="/assets/js/19.c31513f4.js"><link rel="prefetch" href="/assets/js/20.ff0c8b17.js"><link rel="prefetch" href="/assets/js/21.23bfd343.js"><link rel="prefetch" href="/assets/js/22.7b1bcdc8.js"><link rel="prefetch" href="/assets/js/23.9aa9bcc6.js"><link rel="prefetch" href="/assets/js/24.41feae7a.js"><link rel="prefetch" href="/assets/js/25.085c0a62.js"><link rel="prefetch" href="/assets/js/26.28112f5e.js"><link rel="prefetch" href="/assets/js/27.3dfa1162.js"><link rel="prefetch" href="/assets/js/28.64b59646.js"><link rel="prefetch" href="/assets/js/29.5da0daa7.js"><link rel="prefetch" href="/assets/js/30.e061c642.js"><link rel="prefetch" href="/assets/js/31.af9d5f01.js"><link rel="prefetch" href="/assets/js/32.3bb3cd16.js"><link rel="prefetch" href="/assets/js/33.28c6384b.js"><link rel="prefetch" href="/assets/js/34.e24d72db.js"><link rel="prefetch" href="/assets/js/35.066a2949.js"><link rel="prefetch" href="/assets/js/36.3605469b.js"><link rel="prefetch" href="/assets/js/38.c4e1f427.js"><link rel="prefetch" href="/assets/js/39.bf835b74.js"><link rel="prefetch" href="/assets/js/4.130bd99d.js"><link rel="prefetch" href="/assets/js/40.df4753ea.js"><link rel="prefetch" href="/assets/js/41.c0060482.js"><link rel="prefetch" href="/assets/js/42.13e0dffa.js"><link rel="prefetch" href="/assets/js/43.2a7ba197.js"><link rel="prefetch" href="/assets/js/44.4a50ce9b.js"><link rel="prefetch" href="/assets/js/45.04e3bb01.js"><link rel="prefetch" href="/assets/js/46.f860615e.js"><link rel="prefetch" href="/assets/js/47.57f7e152.js"><link rel="prefetch" href="/assets/js/48.c9adb86a.js"><link rel="prefetch" href="/assets/js/49.89d283b4.js"><link rel="prefetch" href="/assets/js/5.bc8341b3.js"><link rel="prefetch" href="/assets/js/50.176d29a8.js"><link rel="prefetch" href="/assets/js/51.73ee13f6.js"><link rel="prefetch" href="/assets/js/6.5dc22b3f.js"><link rel="prefetch" href="/assets/js/7.5d9116e6.js"><link rel="prefetch" href="/assets/js/8.ab4e4f3e.js"><link rel="prefetch" href="/assets/js/9.05f51b5b.js">
    <link rel="stylesheet" href="/assets/css/0.styles.2fd3a0e5.css">
  </head>
  <body>
    <div id="app" data-server-rendered="true"><div class="theme-container"><header class="navbar"><div class="sidebar-button"><svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" role="img" viewBox="0 0 448 512" class="icon"><path fill="currentColor" d="M436 124H12c-6.627 0-12-5.373-12-12V80c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12zm0 160H12c-6.627 0-12-5.373-12-12v-32c0-6.627 5.373-12 12-12h424c6.627 0 12 5.373 12 12v32c0 6.627-5.373 12-12 12z"></path></svg></div> <a href="/" class="home-link router-link-active"><img src="/assets/img/logo.png" alt="quiterr的个人博客" class="logo"> <span class="site-name can-hide">quiterr的个人博客</span></a> <div class="links"><div class="search-box"><input aria-label="Search" autocomplete="off" spellcheck="false" value=""> <!----></div> <nav class="nav-links can-hide"><div class="nav-item"><a href="https://www.jianshu.com/u/e268fe04200a" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/quiterr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.hanclouds.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  hanclouds
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav></div></header> <div class="sidebar-mask"></div> <aside class="sidebar"><nav class="nav-links"><div class="nav-item"><a href="https://www.jianshu.com/u/e268fe04200a" target="_blank" rel="noopener noreferrer" class="nav-link external">
  简书
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://github.com/quiterr" target="_blank" rel="noopener noreferrer" class="nav-link external">
  github
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div><div class="nav-item"><a href="https://www.hanclouds.com/" target="_blank" rel="noopener noreferrer" class="nav-link external">
  hanclouds
  <svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></div> <!----></nav>  <ul class="sidebar-links"><li><section class="sidebar-group collapsable depth-0"><a href="/architecture/" class="sidebar-heading clickable"><span>架构设计</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/source/" class="sidebar-heading clickable"><span>源码阅读</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/design-pattern/" class="sidebar-heading clickable"><span>设计模式</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/frontend/" class="sidebar-heading clickable router-link-active open"><span>前端开发</span> <span class="arrow down"></span></a> <ul class="sidebar-links sidebar-group-items"><li><a href="/frontend/" class="sidebar-link">vue2.0学习笔记</a></li><li><a href="/frontend/1.html" class="sidebar-link">问题集锦</a></li><li><a href="/frontend/2.html" class="active sidebar-link">Nginx笔记</a><ul class="sidebar-sub-headers"><li class="sidebar-sub-header"><a href="/frontend/2.html#_1、nginx环境搭建" class="sidebar-link">1、nginx环境搭建</a></li><li class="sidebar-sub-header"><a href="/frontend/2.html#_2、location配置" class="sidebar-link">2、location配置</a></li><li class="sidebar-sub-header"><a href="/frontend/2.html#_3、upstream配置" class="sidebar-link">3、upstream配置</a></li><li class="sidebar-sub-header"><a href="/frontend/2.html#_4、nginx设置虚拟主机" class="sidebar-link">4、Nginx设置虚拟主机</a></li><li class="sidebar-sub-header"><a href="/frontend/2.html#_5、反向代理" class="sidebar-link">5、反向代理</a></li><li class="sidebar-sub-header"><a href="/frontend/2.html#_6、适配pc或移动设备" class="sidebar-link">6、适配PC或移动设备</a></li><li class="sidebar-sub-header"><a href="/frontend/2.html#_7、gzip压缩配置" class="sidebar-link">7、Gzip压缩配置</a></li></ul></li><li><a href="/frontend/3.html" class="sidebar-link">webpack学习笔记</a></li><li><a href="/frontend/4.html" class="sidebar-link">Nuxt.js学习笔记</a></li><li><a href="/frontend/5.html" class="sidebar-link">ES6学习笔记</a></li></ul></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/database/" class="sidebar-heading clickable"><span>数据库</span> <span class="arrow right"></span></a> <!----></section></li><li><section class="sidebar-group collapsable depth-0"><a href="/collection/" class="sidebar-heading clickable"><span>资料收藏</span> <span class="arrow right"></span></a> <!----></section></li></ul> </aside> <main class="page"> <div class="theme-default-content content__default"><h1 id="nginx笔记"><a href="#nginx笔记" class="header-anchor">#</a> Nginx笔记</h1> <p>2019.3.26</p> <h2 id="_1、nginx环境搭建"><a href="#_1、nginx环境搭建" class="header-anchor">#</a> 1、nginx环境搭建</h2> <p><strong>linux安装</strong></p> <div class="language- extra-class"><pre class="language-text"><code>yum install nginx
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>nginx -v
</code></pre></div><p><strong>windows安装</strong></p> <p>下载zip包解压即可</p> <p><strong>配置文件</strong></p> <p>以下讲的是CentOS7.4环境，windows下图形界面操作即可。</p> <p>使用如下命令查看安装位置</p> <div class="language- extra-class"><pre class="language-text"><code>rpm -ql nginx
</code></pre></div><p>其中<code>/etc/nginx/nginx.conf</code>是核心配置文件。</p> <p><strong>启动、停止、重启</strong></p> <p>以下讲的是CentOS7.4环境。</p> <p>默认情况下，Nginx不会自动启动。</p> <p><strong>nginx直接启动</strong></p> <div class="language- extra-class"><pre class="language-text"><code>nginx
</code></pre></div><p><strong>systemctl命令启动</strong></p> <div class="language- extra-class"><pre class="language-text"><code>systemctl start nginx.service
</code></pre></div><p><strong>停止Nginx服务的四种方法</strong></p> <p>强制关闭</p> <div class="language- extra-class"><pre class="language-text"><code>nginx  -s stop
</code></pre></div><p>安全关闭</p> <div class="language- extra-class"><pre class="language-text"><code>nginx -s quit
</code></pre></div><p>systemctl 停止</p> <div class="language- extra-class"><pre class="language-text"><code>systemctl stop nginx.service
</code></pre></div><p>killall</p> <div class="language- extra-class"><pre class="language-text"><code>killall nginx
</code></pre></div><p><strong>重启Nginx服务</strong></p> <div class="language- extra-class"><pre class="language-text"><code>systemctl restart nginx.service
</code></pre></div><p><strong>重新载入配置文件</strong></p> <div class="language- extra-class"><pre class="language-text"><code>nginx -s reload
</code></pre></div><p><strong>注意</strong>：开发的时候可以在IDEA中配置nginx启动项</p> <h2 id="_2、location配置"><a href="#_2、location配置" class="header-anchor">#</a> 2、location配置</h2> <p>context：http.server</p> <p><strong>语法规则</strong></p> <div class="language- extra-class"><pre class="language-text"><code>location [ = | ~ | ~* | ^~ ] uri { ... }
location @name { ... }
</code></pre></div><p>很简单，一个<code>location</code>关键字，后面跟着可选的修饰符，后面是要匹配的字符，花括号中是要执行的操作。</p> <p><strong>修饰符</strong></p> <ul><li><code>=</code> 表示精确匹配。只有请求的url路径与后面的字符串完全相等时，才会命中。</li> <li><code>~</code> 表示该规则是使用正则定义的，区分大小写。</li> <li><code>~*</code> 表示该规则是使用正则定义的，不区分大小写。</li> <li><code>^~</code> 表示如果该符号后面的字符是最佳匹配，采用该规则，不再进行后续的查找。</li></ul> <p><strong>匹配过程</strong></p> <p>请求的url预处理。例如，对<code>%xx</code>等字符进行解码，去除url中多个相连的<code>/</code>，解析url中的<code>.</code>，<code>..</code>等。</p> <p>location有两种表示形式，一种是使用前缀字符，一种是使用正则。如果是正则的话，前面有<code>~</code>或<code>~*</code>修饰符。</p> <p>具体的匹配过程如下：</p> <ul><li><p>首先检查使用前缀字符定义的location，选择最长匹配的项并记录下来。</p></li> <li><p>如果找到了精确匹配的location，也就是使用了<code>=</code>修饰符的location，结束查找，使用它的配置。</p></li> <li><p>然后按顺序查找使用正则定义的location，如果匹配则停止查找，使用它定义的配置。</p></li> <li><p>如果没有匹配的正则location，则使用前面记录的最长匹配前缀字符location。</p></li></ul> <p>基于以上的匹配过程，我们可以得到以下两点启示：</p> <ol><li><strong>使用正则定义的location在配置文件中出现的顺序很重要</strong>。因为找到第一个匹配的正则后，查找就停止了，后面定义的正则就是再匹配也没有机会了。</li> <li><strong>使用精确匹配可以提高查找的速度</strong>。例如经常请求<code>/</code>的话，可以使用<code>=</code>来定义location。</li></ol> <p><strong>示例</strong></p> <div class="language- extra-class"><pre class="language-text"><code>location = / {
    [ configuration A ]
}

location / {
    [ configuration B ]
}

location /user/ {
    [ configuration C ]
}

location ^~ /images/ {
    [ configuration D ]
}

location ~* \.(gif|jpg|jpeg)$ {
    [ configuration E ]
}
</code></pre></div><p>请求<code>/</code>精准匹配A，不再往下查找。</p> <p>请求<code>/index.html</code>匹配B。首先查找匹配的前缀字符，找到最长匹配是配置B，接着又按照顺序查找匹配的正则。结果没有找到，因此使用先前标记的最长匹配，即配置B。</p> <p>请求<code>/user/index.html</code>匹配C。首先找到最长匹配C，由于后面没有匹配的正则，所以使用最长匹配C。
请求<code>/user/1.jpg</code>匹配E。首先进行前缀字符的查找，找到最长匹配项C，继续进行正则查找，找到匹配项E。因此使用E。</p> <p>请求<code>/images/1.jpg</code>匹配D。首先进行前缀字符的查找，找到最长匹配D。但是，特殊的是它使用了<code>^~</code>修饰符，不再进行接下来的正则的匹配查找，因此使用D。这里，如果没有前面的修饰符，其实最终的匹配是E。大家可以想一想为什么。</p> <p>请求<code>/documents/about.html</code>匹配B。因为B表示任何以<code>/</code>开头的URL都匹配。在上面的配置中，只有B能满足，所以匹配B。</p> <p><strong>location @name的用法</strong></p> <p>@用来定义一个命名location。主要用于内部重定向，不能用来处理正常的请求。其用法如下：</p> <div class="language- extra-class"><pre class="language-text"><code>location / {
    try_files $uri $uri/ @custom
}
location @custom {
    # ...do something
}
</code></pre></div><p><strong>URL尾部的/是否需要</strong></p> <p>关于URL尾部的<code>/</code>有三点需要注意。第一点与location配置有关，其他两点无关。</p> <ol><li>location中的字符有没有<code>/</code>都没有影响。也就是说<code>/user/</code>和<code>/user</code>是一样的。</li> <li>如果URL结构是<code>https://domain.com/</code>的形式，尾部有没有<code>/</code>都不会造成重定向。因为浏览器在发起请求的时候，默认加上了<code>/</code>。虽然很多浏览器在地址栏里也不会显示<code>/</code>。这一点，可以访问<a href="https://www.baidu.com/" target="_blank" rel="noopener noreferrer">baidu<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a>验证一下。</li> <li>如果URL的结构是<code>https://domain.com/some-dir/</code>。尾部如果缺少<code>/</code>将导致重定向。因为根据约定，URL尾部的<code>/</code>表示目录，没有<code>/</code>表示文件。所以访问<code>/some-dir/</code>时，服务器会自动去该目录下找对应的默认文件。如果访问<code>/some-dir</code>的话，服务器会先去找<code>some-dir</code>文件，找不到的话会将<code>some-dir</code>当成目录，重定向到<code>/some-dir/</code>，去该目录下找默认文件。可以去测试一下你的网站是不是这样的。</li></ol> <p><strong>权限控制</strong></p> <div class="language- extra-class"><pre class="language-text"><code>location / {
        deny   123.9.51.42;
        allow  45.76.202.231;
    }
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>location ~\.php$ {
        deny all;
    }
</code></pre></div><h2 id="_3、upstream配置"><a href="#_3、upstream配置" class="header-anchor">#</a> 3、upstream配置</h2> <p><a href="http://nginx.org/en/docs/http/ngx_http_upstream_module.html" target="_blank" rel="noopener noreferrer">官方文档<svg xmlns="http://www.w3.org/2000/svg" aria-hidden="true" x="0px" y="0px" viewBox="0 0 100 100" width="15" height="15" class="icon outbound"><path fill="currentColor" d="M18.8,85.1h56l0,0c2.2,0,4-1.8,4-4v-32h-8v28h-48v-48h28v-8h-32l0,0c-2.2,0-4,1.8-4,4v56C14.8,83.3,16.6,85.1,18.8,85.1z"></path> <polygon fill="currentColor" points="45.7,48.7 51.3,54.3 77.2,28.5 77.2,37.2 85.2,37.2 85.2,14.9 62.8,14.9 62.8,22.9 71.5,22.9"></polygon></svg></a></p> <p>context: http</p> <p><strong>语法规则</strong></p> <div class="language- extra-class"><pre class="language-text"><code>upstream name { ... }
</code></pre></div><p>这个模块是用来定义一组servers，随后可以被其他指令引用</p> <div class="language- extra-class"><pre class="language-text"><code>proxy_pass, fastcgi_pass, uwsgi_pass, scgi_pass, memcached_pass, and grpc_pass
</code></pre></div><p><strong>例子</strong></p> <div class="language- extra-class"><pre class="language-text"><code>upstream backend {
    server backend1.example.com       weight=5;
    server backend2.example.com:8080;
    server unix:/tmp/backend3;

    server backup1.example.com:8080   backup;
    server backup2.example.com:8080   backup;
}

server {
    location / {
        proxy_pass http://backend;
    }
}
</code></pre></div><p>默认是基于weight的轮询，每7个请求会有5个到达backend1。</p> <p><strong>server的语法规则</strong></p> <div class="language- extra-class"><pre class="language-text"><code>server address [parameters];
</code></pre></div><p>可以不指定端口，默认是80。</p> <p>可用的<code>parameters</code></p> <p><code>weight</code> 轮询时的权重，数值越大权重越大，默认为1</p> <p><code>max_fails</code> 允许请求失败的次数，默认为1。当超过最大次数时，返回proxy_next_upstream 模块定义的错误</p> <p><code>fail_timeout</code> 达到max_fails指定的失败次数后，暂停的时间，默认为10秒</p> <p><code>backup</code> 备用服务器, 其它所有的机器down或者忙的时候，才会请求backup机器</p> <p><code>down</code> 表示当前的server暂时不参与负载</p> <p>注意：当只有一个server时max_fails不生效。</p> <p>还有一些参数看不明白含义：<code>resolve</code>、<code>route</code>=<code>*string*</code>、<code>service</code>=<code>*name*</code>、<code>slow_start</code>=<code>*time*</code>、<code>drain</code></p> <p><strong>负载均衡配置</strong></p> <p>ip_hash</p> <div class="language- extra-class"><pre class="language-text"><code>upstream backend{
    ip_hash;
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
}
</code></pre></div><p>fair（第三方插件）</p> <div class="language- extra-class"><pre class="language-text"><code>upstream backend{
    fair;
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
}
</code></pre></div><p>url_hash（第三方插件）</p> <div class="language- extra-class"><pre class="language-text"><code>upstream resinserver{
    server 192.168.1.10:8080;
    server 192.168.1.11:8080;
    hash $request_uri;
    hash_method crc32;
}
</code></pre></div><h2 id="_4、nginx设置虚拟主机"><a href="#_4、nginx设置虚拟主机" class="header-anchor">#</a> 4、Nginx设置虚拟主机</h2> <p>虚拟主机是指在一台物理主机服务器上划分出多个磁盘空间，每个磁盘空间都是一个虚拟主机，都可以对外提供Web服务。</p> <p><strong>基于端口的虚拟主机</strong></p> <p>在/etc/nginx/conf.d/目录下新建一个配置文件test.conf，默认这个目录下的conf文件都会被include</p> <div class="language- extra-class"><pre class="language-text"><code>server{
        listen 8001;
        server_name localhost;
        root /usr/share/nginx/html/html8001;
        index index.html;
}
</code></pre></div><p>在<code>usr/share/nginx/html/html8001/</code>目录下新建index.html文件（先要建一个html8001目录）</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;h1&gt;welcome port 8001&lt;/h1&gt;
</code></pre></div><p>reload配置或重启nginx</p> <p>打开<code>http://localhost:8001/</code>和<code>http://localhost:80/</code>就能看到不同的页面。</p> <p><strong>基于IP的虚拟主机</strong></p> <div class="language- extra-class"><pre class="language-text"><code>server{
        listen 80;
        server_name 112.74.164.244;
        root /usr/share/nginx/html/html8001;
        index index.html;
}
</code></pre></div><p>如果有多个IP就可以这样配置。</p> <p><strong>基于域名的虚拟主机</strong></p> <p>先得有两个域名，并且都指向nginx所在的服务器</p> <p>修改nginx.conf</p> <div class="language- extra-class"><pre class="language-text"><code>server {
    listen       80;
    server_name  site1.yourDomain.com;
</code></pre></div><p>修改test.conf</p> <div class="language- extra-class"><pre class="language-text"><code>server{
        listen 80;
        server_name site2.yourDomain.com;
        root /usr/share/nginx/html/html8001;
        index index.html;
}
</code></pre></div><h2 id="_5、反向代理"><a href="#_5、反向代理" class="header-anchor">#</a> 5、反向代理</h2> <p>基本用法</p> <div class="language- extra-class"><pre class="language-text"><code>server{
        listen 80;
        server_name site2.yourDomain.com;
        location / {
               proxy_pass http://yourDomain.com;
        }
}
</code></pre></div><p>反向代理还有些常用的指令：</p> <ul><li>proxy_set_header :在将客户端请求发送给后端服务器之前，更改来自客户端的请求头信息。</li> <li>proxy_connect_timeout:配置Nginx与后端代理服务器尝试建立连接的超时时间。</li> <li>proxy_read_timeout : 配置Nginx向后端服务器组发出read请求后，等待相应的超时时间。</li> <li>proxy_send_timeout：配置Nginx向后端服务器组发出write请求后，等待相应的超时时间。</li> <li>proxy_redirect :用于修改后端服务器返回的响应头中的Location和Refresh。</li></ul> <h2 id="_6、适配pc或移动设备"><a href="#_6、适配pc或移动设备" class="header-anchor">#</a> 6、适配PC或移动设备</h2> <p>现在很多网站都有PC端和H5站点，根据客户设备的不同，显示出体验更好的页面。虽然有响应式网站设计的方案，但常见的淘宝、京东等这些大型网站都没有采用，而是分开制作站点。</p> <p>在/usr/share/nginx/目录下新建两个文件夹，分别为：pc和mobile目录</p> <p>在pc和miblic目录下，新建两个index.html文件</p> <div class="language- extra-class"><pre class="language-text"><code>&lt;h1&gt;I am pc!&lt;/h1&gt;
</code></pre></div><div class="language- extra-class"><pre class="language-text"><code>&lt;h1&gt;I am mobile!&lt;/h1&gt;
</code></pre></div><p>修改test.conf</p> <div class="language- extra-class"><pre class="language-text"><code>server{
     listen 8001;
     server_name localhost;
     location / {
      root /usr/share/nginx/pc;
      if ($http_user_agent ~* '(Android|webOS|iPhone|iPod|BlackBerry)') {
         root /usr/share/nginx/mobile;
      }
      index index.html;
     }
}
</code></pre></div><h2 id="_7、gzip压缩配置"><a href="#_7、gzip压缩配置" class="header-anchor">#</a> 7、Gzip压缩配置</h2> <p>gzip网页压缩的实现需要浏览器和服务器两边的支持。</p> <p>当浏览器支持gzip压缩时，会在请求消息中包含<code>Accept-Encoding:gzip</code>,这样Nginx就会向浏览器发送听过gzip后的内容，同时在相应信息头中加入<code>Content-Encoding:gzip</code></p> <p>Nginx提供了专门的gzip模块，并且模块中的指令非常丰富。</p> <ul><li>gzip : 该指令用于开启或 关闭gzip模块。</li> <li>gzip_buffers : 设置系统获取几个单位的缓存用于存储gzip的压缩结果数据流。</li> <li>gzip_comp_level : gzip压缩比，压缩级别是1-9，1的压缩级别最低，9的压缩级别最高。压缩级别越高压缩率越大，压缩时间越长。</li> <li>gzip_disable : 可以通过该指令对一些特定的User-Agent不使用压缩功能。</li> <li>gzip_min_length:设置允许压缩的页面最小字节数，页面字节数从相应消息头的Content-length中进行获取。</li> <li>gzip_http_version：识别HTTP协议版本，其值可以是1.1.或1.0.</li> <li>gzip_proxied : 用于设置启用或禁用从代理服务器上收到相应内容gzip压缩。</li> <li>gzip_vary : 用于在响应消息头中添加Vary：Accept-Encoding,使代理服务器根据请求头中的Accept-Encoding识别是否启用gzip压缩。</li></ul> <p>最简单的例子</p> <div class="language- extra-class"><pre class="language-text"><code>http {
   .....
    gzip on;
    gzip_types text/plain application/javascript text/css;
   .....
}
</code></pre></div></div> <footer class="page-edit"><!----> <div class="last-updated"><span class="prefix">Last Updated:</span> <span class="time">1/14/2020, 11:43:09 AM</span></div></footer> <div class="page-nav"><p class="inner"><span class="prev">
      ←
      <a href="/frontend/1.html" class="prev">
        问题集锦
      </a></span> <span class="next"><a href="/frontend/3.html">
        webpack学习笔记
      </a>
      →
    </span></p></div> </main></div><div class="global-ui"></div></div>
    <script src="/assets/js/app.d45e7d8d.js" defer></script><script src="/assets/js/3.f201c9f2.js" defer></script><script src="/assets/js/2.58f2d4b3.js" defer></script><script src="/assets/js/37.0f0334ec.js" defer></script>
  </body>
</html>
