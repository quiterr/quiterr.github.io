(window.webpackJsonp=window.webpackJsonp||[]).push([[12],{293:function(t,s,a){t.exports=a.p+"assets/img/1.1d6de726.png"},294:function(t,s,a){t.exports=a.p+"assets/img/2.e92e3819.png"},295:function(t,s){t.exports="data:image/png;base64,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"},296:function(t,s,a){t.exports=a.p+"assets/img/4.001a74f6.png"},344:function(t,s,a){"use strict";a.r(s);var e=a(0),n=Object(e.a)({},(function(){var t=this,s=t.$createElement,e=t._self._c||s;return e("ContentSlotsDistributor",{attrs:{"slot-key":t.$parent.slotKey}},[e("h1",{attrs:{id:"quartz实现原理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#quartz实现原理"}},[t._v("#")]),t._v(" quartz实现原理")]),t._v(" "),e("p"),e("div",{staticClass:"table-of-contents"},[e("ul",[e("li",[e("a",{attrs:{href:"#概述"}},[t._v("概述")])]),e("li",[e("a",{attrs:{href:"#scheduler创建过程"}},[t._v("Scheduler创建过程")])]),e("li",[e("a",{attrs:{href:"#scheduler启动过程"}},[t._v("Scheduler启动过程")])]),e("li",[e("a",{attrs:{href:"#节点故障的处理"}},[t._v("节点故障的处理")])]),e("li",[e("a",{attrs:{href:"#quartzschedulerthread线程"}},[t._v("QuartzSchedulerThread线程")])]),e("li",[e("a",{attrs:{href:"#misfirehandler线程"}},[t._v("MisfireHandler线程")])])])]),e("p"),t._v(" "),e("p",[t._v("学到的知识：类.this，如何用mysql来做高可用")]),t._v(" "),e("h2",{attrs:{id:"概述"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#概述"}},[t._v("#")]),t._v(" 概述")]),t._v(" "),e("p",[t._v("在看源码分析实现原理之前，肯定要写一个demo来试用下quartz，也方便后续debug调试："),e("a",{attrs:{href:"https://github.com/quiterr/quartz-test",target:"_blank",rel:"noopener noreferrer"}},[t._v("a quartz example"),e("OutboundLink")],1)]),t._v(" "),e("p",[t._v("试过example之后，对基本概念有认识了，一图胜千言，借用一下别人的图：")]),t._v(" "),e("p",[e("img",{attrs:{src:a(293),alt:""}})]),t._v(" "),e("p",[t._v("开源框架的源码一般都很多，逐行去看显然不现实，所以尝试带着问题去看关键业务代码。")]),t._v(" "),e("p",[t._v("尝试列一些问题：")]),t._v(" "),e("ul",[e("li",[t._v("问题1：quartz支持单机部署和集群部署，单机是内存存储（RAMJobStore），集群是数据库存储（对应DefaultClusteredJobStore），在哪里判断区分的？")]),t._v(" "),e("li",[t._v("问题2：我们平常访问数据库会用mybatis之类的orm框架，quartz用的什么，它的sql在哪里？")]),t._v(" "),e("li",[t._v("问题3：jdk做定时任务用的堆这种数据结构，线程模型用的leader-follower；netty的数据结构用的HashedWheelTimer，线程模型是单线程轮询+线程池处理任务；那么quartz用什么数据结构、线程模型？")]),t._v(" "),e("li",[t._v("问题4：悲观锁是如何实现的？")]),t._v(" "),e("li",[t._v("问题5：quartz集群的高可用如何实现的？")]),t._v(" "),e("li",[t._v("问题6：节点如何分配任务？")])]),t._v(" "),e("h2",{attrs:{id:"scheduler创建过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#scheduler创建过程"}},[t._v("#")]),t._v(" Scheduler创建过程")]),t._v(" "),e("p",[t._v("下面是源码阅读了，我看的是quartz 2.3.0版本。在example的主类MyApp中有：")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Scheduler")]),t._v(" scheduler1 "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StdSchedulerFactory")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getScheduler")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("从这里跟进去，很容易找到StdSchedulerFactory的instantiate()方法负责创建scheduler。这个方法大概800行，我直接拉到最后，倒着找，在1325行找到：")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Scheduler")]),t._v(" scheduler "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("instantiate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rsrcs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" qs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("跟进去后是：")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Scheduler")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("instantiate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("QuartzSchedulerResources")]),t._v(" rsrcs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("QuartzScheduler")]),t._v(" qs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Scheduler")]),t._v(" scheduler "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("StdScheduler")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("qs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" scheduler"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("这个代码有点扯了，rsrcs作为参数传进去但并没有使用，而且多看点源码就知道QuartzSchedulerResources的变量一般都命名为qsrcs，是不是命名也有误？")]),t._v(" "),e("p",[t._v("不管怎样，现在知道何时创建Scheduler了。回到1325行，rsrcs是QuartzSchedulerResources类型，而我提前已经知道QuartzSchedulerResources这个类很关键了（因为看过这篇文章"),e("a",{attrs:{href:"https://tech.meituan.com/2014/08/31/mt-crm-quartz.html",target:"_blank",rel:"noopener noreferrer"}},[t._v("https://tech.meituan.com/2014/08/31/mt-crm-quartz.html"),e("OutboundLink")],1),t._v("）")]),t._v(" "),e("p",[t._v("干脆把1325前面几行也贴出来：")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[t._v("rsrcs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setJobStore")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("js"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// add plugins")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("for")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("int")]),t._v(" i "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<")]),t._v(" plugins"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("length"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v(" i"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("++")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    rsrcs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("addSchedulerPlugin")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("plugins"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("[")]),t._v("i"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("]")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n\nqs "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("QuartzScheduler")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rsrcs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" idleWaitTime"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dbFailureRetry"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\nqsInited "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("true")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n"),e("span",{pre:!0,attrs:{class:"token comment"}},[t._v("// Create Scheduler ref...")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Scheduler")]),t._v(" scheduler "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("instantiate")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rsrcs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" qs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("这里QuartzScheduler实现的是RemotableQuartzScheduler，我们用的StdScheduler实现的是Scheduler接口。这两个的区别借用网上找的一段话来解释：")]),t._v(" "),e("blockquote",[e("p",[t._v("调度器（Scheduler）是Quartz框架的心脏，用来管理触发器和Job，并保证Job能被触发执行。程序员与框架内部之间的调用都是通过org.quartz.Scheduler接口来完成的。对于Scheduler接口的实现，其实只是核心调度（org.quartz.core.QuartzScheduler）的一个代理，对代理的方法进行调用时会传递到底层核心调度实例上。QuartzScheduler处于Quartz框架的根位置，驱动着整个Quartz框架。")])]),t._v(" "),e("p",[t._v("继续往上找js是哪里创建的，在1263行：")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("js "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("instanceof")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("JobStoreSupport")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("JobStoreSupport")]),t._v(" jjs "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("JobStoreSupport")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("js"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    jjs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setDbRetryInterval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("dbFailureRetry"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("threadsInheritInitalizersClassLoader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n        jjs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setThreadsInheritInitializersClassLoadContext")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("threadsInheritInitalizersClassLoader"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    \n    jjs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("setThreadExecutor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("threadExecutor"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("对于JobStoreSupport：")]),t._v(" "),e("blockquote",[e("p",[t._v("Contains base functionality for JDBC-based JobStore implementations.")])]),t._v(" "),e("p",[t._v("所以逻辑就是，如果js是数据库，那么就设置重试间隔和处理线程。")]),t._v(" "),e("p",[t._v("1243行，如果是集群需要分配一个实例ID：")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("js"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("isClustered")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    schedInstId "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" instanceIdGenerator"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("generateInstanceId")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("实例ID有三种实现，分别是hostname，hostname+timestamp，用户配置id。")]),t._v(" "),e("p",[t._v("在885行，通过用户配置的类名，用反射的方式创建Semaphore。\n翻一下源码包，在org.quartz.impl.jdbcjobstore包下有SimpleSemaphore（内存）、StdRowLockSemaphore和UpdateLockRowSemaphore等。\nBTW，quartz的Semaphore是自己定义的接口，没有用JDK的信号量。")]),t._v(" "),e("p",[t._v("在org.quartz.impl.jdbcjobstore包下，同时也看到了一些sql文件，是用来建表的脚本。")]),t._v(" "),e("p",[e("img",{attrs:{src:a(294),alt:""}})]),t._v(" "),e("p",[t._v("867行，原来js也是反射构建的：")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[t._v("js "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("JobStore")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" loadHelper"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("loadClass")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("jsClass"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("newInstance")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("857行：")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("String")]),t._v(" jsClass "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" cfg"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getStringProperty")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("PROP_JOB_STORE_CLASS"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("RAMJobStore")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("class")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getName")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("到这里就解答了第一个问题，quartz是通过配置（org.quartz.jobStore.class）来区分数据库和内存。")]),t._v(" "),e("p",[t._v("前面提到StdScheduler没有和QuartzSchedulerResources关联。在1321行，可以知道QuartzSchedulerResources是和QuartzScheduler关联的。")]),t._v(" "),e("h2",{attrs:{id:"scheduler启动过程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#scheduler启动过程"}},[t._v("#")]),t._v(" Scheduler启动过程")]),t._v(" "),e("p",[t._v("QuartzScheduler的start方法是启动入口。")]),t._v(" "),e("p",[t._v("schedulerStarted这个方法如果是内存，不会做任何事:")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),t._v("resources"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getJobStore")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("schedulerStarted")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("重点关注集群模式，需要先加个配置文件quartz.properties，官方的example有介绍，前文贴的quartz example里也有，这里就不贴配置了。")]),t._v(" "),e("p",[t._v("重启之后，进入JobStoreSupport类的schedulerStarted()方法，这里学到了类.this的用法：")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("public")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("void")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("initialize")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("manage")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n\n    "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ThreadExecutor")]),t._v(" executor "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getThreadExecutor")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n    executor"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("execute")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("ClusterManager")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("上述代码启动了JobStoreSupport.ClusterManager线程，该线程的关键逻辑run方法中，具体在JobStoreSupport的3957行manage()方法中：")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("if")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!")]),t._v("shutdown "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("&&")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("this")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("manage")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("signalSchedulingChangeImmediately")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("0L")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("而manage()调的是doCheckin()，BTW，netty也是喜欢在关键方法上加个do。\ndoCheckin()的第一步就是findFailedInstances()，跟进去就会发现要先创建我们在配置文件中指定的StdJDBCDelegate，\n之后，调的是StdJDBCDelegate的selectSchedulerStateRecords()，在这个方法我们总算发现了要执行的sql语句。")]),t._v(" "),e("p",[t._v("所有的sql都在StdJDBCConstants类中，到这里解答了本文开始的第二个问题，quartz并没有用任何的ORM框架，而是原始的JDBC。")]),t._v(" "),e("p",[t._v("最终构造出查fail instance的sql：")]),t._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" qrtz_SCHEDULER_STATE "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" SCHED_NAME "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'TestScheduler'")]),t._v("\n")])])]),e("p",[t._v("JobStoreSupport检查instance是否fail的逻辑也很简单，数据库中存了每次checkin的时间，\n这个时间加上interval就是下一次该检查的时间，给个7500L的延迟，如果这样还比当前时间小，就会判定为fail：")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("protected")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("long")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("calcFailedIfAfter")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("SchedulerStateRecord")]),t._v(" rec"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("{")]),t._v("\n    "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("return")]),t._v(" rec"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getCheckinTimestamp")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("Math")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("max")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rec"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("getCheckinInterval")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" \n                "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("System")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("currentTimeMillis")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),t._v(" lastCheckin"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("+")]),t._v("\n        "),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("7500L")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("}")]),t._v("\n")])])]),e("p",[t._v("到这里就分析完了ClusterManager线程的主要逻辑，就是检查集群中各个instance是否正常，这是quartz保障高可用的核心逻辑了，也就是问题5的解答。\n检测到instance失败以后，有调clusterRecover()方法，这一块后面单独分析，这里先只关注启动过程。")]),t._v(" "),e("p",[t._v("如果多扣一些细节，会发现第一次Checkin时，会到qrtz_locks表里去插入两条记录(3337行commit之后才会执行插入)，作为悲观锁：")]),t._v(" "),e("p",[e("img",{attrs:{src:a(295),alt:""}})]),t._v(" "),e("p",[t._v("到这里，问题4可以解答了，我们知道了悲观锁是用prepareStatement做的，具体的sql是：")]),t._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" qrtz_LOCKS "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" SCHED_NAME "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'TestScheduler'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("AND")]),t._v(" LOCK_NAME "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ? "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FOR")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("UPDATE")]),t._v("\n"),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INSERT")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("INTO")]),t._v(" qrtz_LOCKS"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("SCHED_NAME"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" LOCK_NAME"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("VALUES")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'TestScheduler'")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" ?"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v("\n")])])]),e("p",[t._v("第一个sql是行锁，第二行是执行操作（当然了这里是个特殊操作，如果已经插入过，是不会再重复插入的，对应StdRowLockSemaphore的97行的判断）。")]),t._v(" "),e("p",[t._v("关于启动过程总结一下：")]),t._v(" "),e("ul",[e("li",[t._v("主要是执行jobStore的schedulerStarted()，当然有一些其他动作，但是不复杂，看看就好了。")]),t._v(" "),e("li",[t._v("schedulerStarted()做两件事，一是启动ClusterManager线程，二是启动MisfireHandler线程，关于后者也专门用一小节来分析吧。")])]),t._v(" "),e("p",[t._v("BTW，启动过程有个步骤是startPlugins()，当然我这里没有配置任何plugins，所以什么都没执行，但是这里也许会比较有趣。")]),t._v(" "),e("h2",{attrs:{id:"节点故障的处理"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#节点故障的处理"}},[t._v("#")]),t._v(" 节点故障的处理")]),t._v(" "),e("p",[t._v("在上一节，分析了ClusterManager线程负责监测集群状态，检测到检测到instance失败以后，会调clusterRecover()方法，这一节来看下源码。")]),t._v(" "),e("p",[t._v("clusterRecover()在JobStoreSupport的3476行。")]),t._v(" "),e("p",[t._v("对每一个fail instance，执行selectInstancesFiredTriggerRecords方法，对应的sql语句是：")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[t._v("SELECT "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("*")]),t._v(" FROM qrtz_FIRED_TRIGGERS "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("WHERE")]),t._v(" SCHED_NAME "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'TestScheduler'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("AND")]),t._v(" INSTANCE_NAME "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" instance_one\n")])])]),e("p",[t._v("从数据库查到fired trigger之后，用数据表的trigger_name、trigger_group组成triggerKey，用job_name、job_group组成jobKey。")]),t._v(" "),e("p",[t._v("这里稍微复杂些的是fired_triggers表中的state字段，包括triggers表中也有一个trigger_state字段。借用网上的图：")]),t._v(" "),e("p",[e("img",{attrs:{src:a(296),alt:""}})]),t._v(" "),e("p",[t._v("对每一个fired trigger：")]),t._v(" "),e("ul",[e("li",[t._v("释放BLOCKED的triggers：如果状态是BLOCKED，更新为WAITING；如果状态是PAUSED_BLOCKED，更新为PAUSED")]),t._v(" "),e("li",[t._v("如果状态是ACQUIRED，更新为WAITING，否则如果fired_triggers表中的request_recovery字段为true，表示job没有执行完毕并且要求恢复")])]),t._v(" "),e("p",[t._v("job recover的逻辑：")]),t._v(" "),e("ul",[e("li",[t._v("先用jobKey去job_details表查job是否存在。")]),t._v(" "),e("li",[t._v("构造一个SimpleTriggerImpl，构造完成后插入triggers表，它的trigger_name是recover_instanceId_timestamp，标识这个trigger的特殊性，其他字段保持和原来的trigger一致。")])]),t._v(" "),e("p",[t._v("全部遍历处理完成后，一次性删除fired_triggers表中记录。")]),t._v(" "),e("p",[t._v("遍历对刚刚删除的triggers（有用HashSet保存triggerKey），查triggers表看状态是否是COMPLETE，\n如果是进一步查fired_triggers表是否存在记录，没有记录时删除triggers表中的记录。")]),t._v(" "),e("p",[t._v("clusterRecover()进入之前有获取STATE_ACCESS和TRIGGER_ACCESS锁的操作，执行完后commit之后就会释放锁。")]),t._v(" "),e("h2",{attrs:{id:"quartzschedulerthread线程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#quartzschedulerthread线程"}},[t._v("#")]),t._v(" QuartzSchedulerThread线程")]),t._v(" "),e("p",[t._v("启动过程有一步是：")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[t._v("schedThread"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(".")]),e("span",{pre:!0,attrs:{class:"token function"}},[t._v("togglePause")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),e("span",{pre:!0,attrs:{class:"token boolean"}},[t._v("false")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("schedThread这个线程是QuartzSchedulerThread类型，是调度的核心线程，定义在QuartzScheduler中。")]),t._v(" "),e("p",[t._v("回顾Scheduler的创建过程，在StdSchedulerFactory的1321行：")]),t._v(" "),e("div",{staticClass:"language-java extra-class"},[e("pre",{pre:!0,attrs:{class:"language-java"}},[e("code",[t._v("qs "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("new")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token class-name"}},[t._v("QuartzScheduler")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("rsrcs"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" idleWaitTime"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" dbFailureRetry"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(";")]),t._v("\n")])])]),e("p",[t._v("进到QuartzScheduler的构造函数就会发现创建了QuartzSchedulerThread。")]),t._v(" "),e("p",[t._v("核心逻辑在run函数：")]),t._v(" "),e("ul",[e("li",[t._v("检查halted标志，如果为true就终止")]),t._v(" "),e("li",[t._v("检查paused标志，如果为true就sleep 1秒")]),t._v(" "),e("li",[t._v("acquiresFailed记录了访问数据库失败的次数，如果大于1，会sleep(delay)的时间，delay如果默认是15秒")]),t._v(" "),e("li",[t._v("获取可用work线程的数量（availThreadCount），如果为0，获取的过程中会阻塞直到有可用线程")]),t._v(" "),e("li",[t._v("获取接下来30秒内要执行的triggers，最多获取数量maxCount由availThreadCount和配置的batchSize中的较小值决定，如果maxCount大于1需要申请TRIGGER_ACCESS锁。对于获取到的triggers，遍历，获取每个trigger对应的job，如果job标记了@ConcurrentExectionDisallowed，则跳过，否则把trigger的状态从WAITING更新为ACQUIRED。同时，也会在fired_triggers插入一条记录，状态也是ACQUIRED。")])]),t._v(" "),e("p",[t._v("这一步比较复杂，最好debug一下，执行的sql是：")]),t._v(" "),e("div",{staticClass:"language-sql extra-class"},[e("pre",{pre:!0,attrs:{class:"language-sql"}},[e("code",[e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("SELECT")]),t._v(" TRIGGER_NAME"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" TRIGGER_GROUP"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" NEXT_FIRE_TIME"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" PRIORITY "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("FROM")]),t._v(" \n\nqrtz_TRIGGERS "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("WHERE")]),t._v(" SCHED_NAME "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token string"}},[t._v("'TestScheduler'")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("AND")]),t._v(" TRIGGER_STATE "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" ? \n\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("AND")]),t._v(" NEXT_FIRE_TIME "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("<=")]),t._v(" ? "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("AND")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("MISFIRE_INSTR "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("OR")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v("(")]),t._v("MISFIRE_INSTR "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("!=")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("-")]),e("span",{pre:!0,attrs:{class:"token number"}},[t._v("1")]),t._v(" \n\n"),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v("AND")]),t._v(" NEXT_FIRE_TIME "),e("span",{pre:!0,attrs:{class:"token operator"}},[t._v(">=")]),t._v(" ?"),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(")")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ORDER")]),t._v(" "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("BY")]),t._v(" NEXT_FIRE_TIME "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("ASC")]),e("span",{pre:!0,attrs:{class:"token punctuation"}},[t._v(",")]),t._v(" PRIORITY "),e("span",{pre:!0,attrs:{class:"token keyword"}},[t._v("DESC")]),t._v("\n")])])]),e("p",[t._v("其中的misfire有个threshold时间，默认是60秒。")]),t._v(" "),e("p",[t._v("继续run方法的核心逻辑（下面部分copy自"),e("a",{attrs:{href:"https://juejin.im/post/5c3bf24951882523d3201c54#heading-12",target:"_blank",rel:"noopener noreferrer"}},[t._v("Quartz原理解密"),e("OutboundLink")],1),t._v("）：")]),t._v(" "),e("ul",[e("li",[t._v("等待直到获取的trigger中最先执行的trigger在2ms内；")]),t._v(" "),e("li",[t._v("triggersFired：\n"),e("ul",[e("li",[t._v("更新firedTrigger的status=EXECUTING;")]),t._v(" "),e("li",[t._v("更新trigger下一次触发的时间；")]),t._v(" "),e("li",[t._v("更新trigger的状态：无状态的trigger->WAITING，有状态的trigger->BLOCKED，若nextFireTime==null ->COMPLETE；")]),t._v(" "),e("li",[t._v("commit connection,释放锁；")])])]),t._v(" "),e("li",[t._v("针对每个要执行的trigger，创建JobRunShell，并放入线程池执行：\n"),e("ul",[e("li",[t._v("execute:执行job;")]),t._v(" "),e("li",[t._v("获取TRIGGER_ACCESS锁;若是有状态的job：")]),t._v(" "),e("li",[t._v("更新trigger状态：BLOCKED->WAITING,PAUSED_BLOCKED->BLOCKED;")]),t._v(" "),e("li",[t._v("若@PersistJobDataAfterExecution，则updateJobData;")]),t._v(" "),e("li",[t._v("删除firedTrigger;c")]),t._v(" "),e("li",[t._v("ommit connection，释放锁")])])]),t._v(" "),e("li",[t._v("如果有查到trigger，马上进行下一次循环，如果没有则等待大概30秒，继续下一次循环")])]),t._v(" "),e("p",[t._v("从以上过程可以看到，其实quartz没有任务分配机制，各个instance是自主一批一批的去数据库查任务，每个批次最多是可用线程数或者配置的maxBatchSize（默认是1），每一批数量都很小，这样就基本达到了集群的负载均衡。这就是问题6的解答了。")]),t._v(" "),e("h2",{attrs:{id:"misfirehandler线程"}},[e("a",{staticClass:"header-anchor",attrs:{href:"#misfirehandler线程"}},[t._v("#")]),t._v(" MisfireHandler线程")]),t._v(" "),e("p",[t._v("对于问题3，数据结构是mysql中的那几张表，线程模型是QuartzSchedulerThread、ClusterManager、MisfireHandler、SimpleThreadPool的结合。")])])}),[],!1,null,null,null);s.default=n.exports}}]);